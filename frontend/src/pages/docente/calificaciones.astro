---
import DocenteLayout from '../../layouts/DocenteLayout.astro';
import DocenteHeader from '../../components/DocenteHeader.astro';

export const prerender = false;
---

<DocenteLayout title="Calificaciones - Yatiña">
  <DocenteHeader>Calificar Actividades</DocenteHeader>
  <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
    <div class="mb-6">
      <h2 class="text-2xl font-bold text-purple-800 mb-2">Calificar Actividades</h2>
      <p class="text-gray-600">Selecciona un curso y luego una actividad para calificar las respuestas de los estudiantes</p>
    </div>

    <!-- Selección de Curso -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <label class="block text-lg font-semibold text-gray-800 mb-4">
        <i class="fas fa-book mr-2 text-purple-600"></i>Selecciona un Curso:
      </label>
      <select id="curso-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
        <option value="">-- Cargando cursos --</option>
      </select>
    </div>

    <!-- Selección de Sección (si hay múltiples) -->
    <div id="seccion-container" class="bg-white rounded-lg shadow p-6 mb-6 hidden">
      <label class="block text-lg font-semibold text-gray-800 mb-4">
        <i class="fas fa-layer-group mr-2 text-purple-600"></i>Selecciona una Sección:
      </label>
      <select id="seccion-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
        <option value="">-- Cargando secciones --</option>
      </select>
    </div>

    <!-- Selección de Actividad -->
    <div id="actividad-container" class="bg-white rounded-lg shadow p-6 mb-6 hidden">
      <label class="block text-lg font-semibold text-gray-800 mb-4">
        <i class="fas fa-tasks mr-2 text-purple-600"></i>Selecciona una Actividad:
      </label>
      <select id="actividad-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
        <option value="">-- Cargando actividades --</option>
      </select>
    </div>

    <!-- Tabla de Calificación -->
    <div id="calificacion-container" class="bg-white rounded-lg shadow overflow-hidden hidden">
      <div class="p-6 border-b border-gray-200">
        <h3 id="actividad-nombre" class="text-xl font-semibold text-purple-800"></h3>
        <p id="actividad-descripcion" class="text-gray-600 text-sm mt-1"></p>
        <p id="actividad-puntaje" class="text-gray-600 text-sm mt-2">
          <strong>Puntaje Máximo:</strong> <span class="text-purple-600 font-semibold"></span>
        </p>
      </div>
      
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-purple-600 text-white">
            <tr>
              <th class="px-6 py-3 text-left text-sm font-semibold">Estudiante</th>
              <th class="px-6 py-3 text-left text-sm font-semibold">Correo</th>
              <th class="px-6 py-3 text-center text-sm font-semibold">Puntaje Obtenido</th>
              <th class="px-6 py-3 text-center text-sm font-semibold">Acciones</th>
            </tr>
          </thead>
          <tbody id="estudiantes-calificacion" class="divide-y divide-gray-200">
            <tr>
              <td colspan="4" class="px-6 py-8 text-center text-gray-500">
                Cargando estudiantes...
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="p-4 bg-gray-50 border-t border-gray-200 flex justify-end gap-4">
        <button id="guardar-todas-btn" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors flex items-center gap-2">
          <i class="fas fa-save"></i>
          Guardar Todos
        </button>
      </div>
    </div>

    <style>
      .calificacion-input {
        width: 100px;
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        text-align: center;
      }
      
      .calificacion-input:focus {
        outline: none;
        ring: 2px solid #a855f7;
        border-color: #a855f7;
      }
    </style>
  </main>
</DocenteLayout>

<script type="module">
  import { getSecciones } from '../../services/seccionService.js';
  import { getActividades } from '../../services/notaService.js';
  import { getAlumnosBySeccion } from '../../services/matriculaService.js';
  import { updateNota } from '../../services/notaService.js';

  let cursosData = {};
  let seccionesData = {};
  let actividadesData = {};

  // Obtener secciones al cargar
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/login';
        return;
      }

      // Obtener id_docente_perfil del usuario actual
      const user = localStorage.getItem('user');
      let id_docente_perfil = null;
      
      if (user) {
        const userData = JSON.parse(user);
        id_docente_perfil = userData.id_docente_perfil;
      }

      // Obtener secciones filtrando por docente
      const secciones = id_docente_perfil
        ? await getSecciones({ id_docente_perfil })
        : [];
      
      // Agrupar por curso
      const cursos = new Map();
      secciones.forEach(seccion => {
        if (!cursos.has(seccion.id_curso)) {
          cursos.set(seccion.id_curso, {
            id_curso: seccion.id_curso,
            nombre_curso: seccion.nombre_curso,
            secciones: []
          });
        }
        cursos.get(seccion.id_curso).secciones.push(seccion);
      });

      cursosData = Object.fromEntries(cursos);
      
      // Llenar select de cursos
      const cursoSelect = document.getElementById('curso-select');
      cursoSelect.innerHTML = '<option value="">-- Selecciona un curso --</option>';
      
      Object.entries(cursosData).forEach(([id, curso]) => {
        const option = document.createElement('option');
        option.value = id;
        option.textContent = curso.nombre_curso;
        cursoSelect.appendChild(option);
      });

      cursoSelect.addEventListener('change', onCursoChange);

    } catch (error) {
      console.error('Error al cargar datos:', error);
      alert('Error al cargar los cursos');
    }
  });

  async function onCursoChange(e) {
    const id_curso = e.target.value;
    const seccionContainer = document.getElementById('seccion-container');
    const actividadContainer = document.getElementById('actividad-container');
    const calificacionContainer = document.getElementById('calificacion-container');

    seccionContainer.classList.add('hidden');
    actividadContainer.classList.add('hidden');
    calificacionContainer.classList.add('hidden');

    if (!id_curso) return;

    const curso = cursosData[id_curso];
    const seccionSelect = document.getElementById('seccion-select');
    
    if (curso.secciones.length > 1) {
      seccionContainer.classList.remove('hidden');
      seccionSelect.innerHTML = '<option value="">-- Selecciona una sección --</option>';
      curso.secciones.forEach(seccion => {
        const option = document.createElement('option');
        option.value = seccion.id_seccion;
        option.textContent = `${seccion.nombre_seccion} (${seccion.total_estudiantes || 0} estudiantes)`;
        seccionSelect.appendChild(option);
      });
      seccionSelect.addEventListener('change', onSeccionChange);
    } else {
      // Si solo hay una sección, cargarla automáticamente
      onSeccionChange({ target: { value: curso.secciones[0].id_seccion } });
    }
  }

  async function onSeccionChange(e) {
    const id_seccion = e.target.value;
    const actividadContainer = document.getElementById('actividad-container');
    const calificacionContainer = document.getElementById('calificacion-container');

    actividadContainer.classList.add('hidden');
    calificacionContainer.classList.add('hidden');

    if (!id_seccion) return;

    try {
      // Obtener actividades de la sección
      const actividades = await getActividades({ id_seccion });
      
      if (!Array.isArray(actividades) || actividades.length === 0) {
        alert('No hay actividades en esta sección');
        return;
      }

      actividadContainer.classList.remove('hidden');
      const actividadSelect = document.getElementById('actividad-select');
      actividadSelect.innerHTML = '<option value="">-- Selecciona una actividad --</option>';
      
      actividades.forEach(actividad => {
        const option = document.createElement('option');
        option.value = actividad.id_actividad;
        option.textContent = `${actividad.titulo} (${actividad.tipo})`;
        actividadSelect.appendChild(option);
        actividadesData[actividad.id_actividad] = actividad;
      });

      actividadSelect.addEventListener('change', onActividadChange);
      
      // Guardar la sección actual
      window.currentSeccion = id_seccion;

    } catch (error) {
      console.error('Error al cargar actividades:', error);
      alert('Error al cargar las actividades');
    }
  }

  async function onActividadChange(e) {
    const id_actividad = e.target.value;
    const calificacionContainer = document.getElementById('calificacion-container');

    calificacionContainer.classList.add('hidden');

    if (!id_actividad) return;

    try {
      const actividad = actividadesData[id_actividad];
      
      // Obtener estudiantes de la sección
      const estudiantes = await getAlumnosBySeccion(window.currentSeccion);

      if (!Array.isArray(estudiantes) || estudiantes.length === 0) {
        alert('No hay estudiantes en esta sección');
        return;
      }

      // Mostrar información de la actividad
      document.getElementById('actividad-nombre').textContent = actividad.titulo;
      document.getElementById('actividad-descripcion').textContent = actividad.descripcion || 'Sin descripción';
      document.getElementById('actividad-puntaje').querySelector('span').textContent = actividad.puntaje_max || 20;

      // Llenar tabla con estudiantes
      const tbody = document.getElementById('estudiantes-calificacion');
      tbody.innerHTML = estudiantes.map((est, idx) => `
        <tr>
          <td class="px-6 py-4 text-sm font-medium text-gray-900">${est.nombres} ${est.apellidos}</td>
          <td class="px-6 py-4 text-sm text-gray-700">${est.correo || '-'}</td>
          <td class="px-6 py-4 text-center">
            <input 
              type="number" 
              class="calificacion-input" 
              data-id-matricula="${est.id_matricula}"
              data-id-actividad="${id_actividad}"
              value="${est.nota_final || ''}"
              min="0"
              max="${actividad.puntaje_max || 20}"
              step="0.1"
            />
          </td>
          <td class="px-6 py-4 text-center">
            <button 
              class="calificar-individual bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700"
              data-id-matricula="${est.id_matricula}"
              data-id-actividad="${id_actividad}"
            >
              Guardar
            </button>
          </td>
        </tr>
      `).join('');

      // Eventos de botones individuales
      document.querySelectorAll('.calificar-individual').forEach(btn => {
        btn.addEventListener('click', guardarCalificacionIndividual);
      });

      // Evento del botón guardar todos
      document.getElementById('guardar-todas-btn').addEventListener('click', guardarTodasLasCalificaciones);

      calificacionContainer.classList.remove('hidden');
      window.currentActividad = id_actividad;

    } catch (error) {
      console.error('Error al cargar estudiantes:', error);
      alert('Error al cargar los estudiantes');
    }
  }

  async function guardarCalificacionIndividual(e) {
    const btn = e.target;
    const id_matricula = btn.dataset.idMatricula;
    const id_actividad = btn.dataset.idActividad;
    
    const input = document.querySelector(`input[data-id-matricula="${id_matricula}"][data-id-actividad="${id_actividad}"]`);
    const puntaje = parseFloat(input.value);

    if (isNaN(puntaje)) {
      alert('Por favor ingresa un puntaje válido');
      return;
    }

    try {
      btn.disabled = true;
      btn.textContent = 'Guardando...';
      
      const token = localStorage.getItem('token');
      const API_URL = 'http://localhost:4000/api';
      
      // Enviar al API para guardar
      const response = await fetch(`${API_URL}/respuestas-alumnos/calificar-actividad`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          id_actividad: parseInt(id_actividad),
          id_matricula: parseInt(id_matricula),
          puntaje_obtenido: puntaje
        })
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Error al guardar');
      }

      const data = await response.json();
      console.log('✅ Calificación guardada:', data);
      
      // Limpiar caché del navegador
      if ('caches' in window) {
        caches.keys().then(cacheNames => {
          cacheNames.forEach(cacheName => {
            caches.delete(cacheName);
          });
        });
      }
      
      // Mostrar éxito
      btn.textContent = '✓ Guardado';
      input.style.borderColor = '#10b981';
      
      // Notificar que debe refrescar analíticas
      mostrarNotificacion('Calificación guardada. ⬆️ Ve a Analíticas y recarga para ver los cambios', 'success');
      
      setTimeout(() => {
        btn.textContent = 'Guardar';
        btn.disabled = false;
        input.style.borderColor = '#d1d5db';
      }, 2000);

    } catch (error) {
      console.error('Error al guardar:', error);
      alert(`Error al guardar la calificación: ${error.message}`);
      btn.disabled = false;
      btn.textContent = 'Guardar';
    }
  }

  async function guardarTodasLasCalificaciones() {
    const inputs = document.querySelectorAll('.calificacion-input');
    const btn = document.getElementById('guardar-todas-btn');
    
    try {
      btn.disabled = true;
      btn.textContent = 'Guardando...';

      const token = localStorage.getItem('token');
      const API_URL = 'http://localhost:4000/api';
      
      let count = 0;
      let errors = 0;
      
      // Guardar cada calificación
      for (const input of inputs) {
        const puntaje = parseFloat(input.value);
        
        if (!isNaN(puntaje)) {
          const id_matricula = input.dataset.idMatricula;
          const id_actividad = input.dataset.idActividad;
          
          try {
            const response = await fetch(`${API_URL}/respuestas-alumnos/calificar-actividad`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify({
                id_actividad: parseInt(id_actividad),
                id_matricula: parseInt(id_matricula),
                puntaje_obtenido: puntaje
              })
            });

            if (response.ok) {
              count++;
              input.style.borderColor = '#10b981';
            } else {
              errors++;
              input.style.borderColor = '#ef4444';
            }
          } catch (err) {
            console.error('Error guardando individual:', err);
            errors++;
            input.style.borderColor = '#ef4444';
          }
        }
      }

      // Limpiar caché del navegador
      if ('caches' in window) {
        caches.keys().then(cacheNames => {
          cacheNames.forEach(cacheName => {
            caches.delete(cacheName);
          });
        });
      }

      // Mostrar resultado
      if (errors === 0) {
        btn.textContent = `✓ ${count} calificaciones guardadas`;
        mostrarNotificacion(`${count} calificaciones guardadas. ⬆️ Ve a Analíticas y recarga para ver los cambios`, 'success');
      } else {
        btn.textContent = `⚠️ ${count} guardadas, ${errors} errores`;
        mostrarNotificacion(`${count} calificaciones guardadas, ${errors} errores. ⬆️ Ve a Analíticas y recarga para ver los cambios`, 'warning');
      }
      
      setTimeout(() => {
        btn.textContent = 'Guardar Todos';
        btn.disabled = false;
      }, 3000);

    } catch (error) {
      console.error('Error al guardar:', error);
      alert('Error al guardar las calificaciones');
      btn.disabled = false;
      btn.textContent = 'Guardar Todos';
    }
  }

  // Función para mostrar notificaciones
  function mostrarNotificacion(mensaje, tipo = 'info') {
    // Crear elemento de notificación
    const notif = document.createElement('div');
    notif.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50 animate-slide-in ${
      tipo === 'success' ? 'bg-green-500' : 
      tipo === 'warning' ? 'bg-yellow-500' : 
      'bg-blue-500'
    }`;
    notif.textContent = mensaje;
    document.body.appendChild(notif);
    
    // Eliminar después de 5 segundos
    setTimeout(() => {
      notif.remove();
    }, 5000);
  }
</script>
