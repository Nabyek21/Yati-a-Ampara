---
import UsuarioLayout from '../layouts/UsuarioLayout.astro';
import UsuarioHeader from '../components/UsuarioHeader.astro';
---

<UsuarioLayout title="Catálogo de Cursos - Yatiña">
  <UsuarioHeader />
  <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
    <div class="mb-4">
      <a href="/usuario" class="text-purple-600 hover:text-purple-800 flex items-center">
        <i class="fas fa-arrow-left mr-2"></i>
        Volver a Mis Cursos
      </a>
    </div>
    <h1 class="text-3xl font-bold text-purple-800 mb-2">Catálogo de Cursos</h1>
    <p class="text-gray-600 mb-6">Explora los cursos disponibles para tu carrera.</p>
    <div id="cursos-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- Cursos se cargarán aquí -->
    </div>
  </main>
</UsuarioLayout>

<script type="module">
  import { getCursos } from '../services/cursoService.js';
  import { getSecciones } from '../services/seccionService.js';

  document.addEventListener('DOMContentLoaded', async () => {
    const cursosContainer = document.getElementById('cursos-container');
    try {
      const cursos = await getCursos();
      if (cursos.length === 0) {
        cursosContainer.innerHTML = '<p>No hay cursos disponibles.</p>';
        return;
      }

      // Obtener todas las secciones para mostrar info de las secciones del curso
      let todasLasSecciones = [];
      try {
        todasLasSecciones = await getSecciones({});
      } catch (err) {
        console.warn('Error cargando secciones:', err);
      }

      cursosContainer.innerHTML = cursos.map(curso => {
        // Filtrar secciones de este curso
        const seccionesCurso = todasLasSecciones.filter(s => s.id_curso === curso.id_curso);
        const seccionesInfo = seccionesCurso.slice(0, 2).map(s => 
          `<span class="inline-block bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded mr-1 mb-1">${s.nombre_seccion || 'Sección'}</span>`
        ).join('');
        const masSeccionesText = seccionesCurso.length > 2 ? `<span class="text-xs text-gray-600">+${seccionesCurso.length - 2} más</span>` : '';

        return `
          <div class="bg-white rounded-lg shadow hover:shadow-lg transition-shadow overflow-hidden flex flex-col h-full">
            <div class="bg-purple-600 p-6 text-white">
              <h4 class="text-2xl font-bold">${curso.nombre}</h4>
            </div>
            <div class="p-6 flex-1 flex flex-col">
              <p class="text-gray-800 font-medium mb-2">${curso.nombre_especialidad || 'Especialidad no especificada'}</p>
              <p class="text-sm text-gray-600 mb-3">${curso.descripcion || 'Sin descripción'}</p>
              
              <div class="mb-3 flex-1">
                <p class="text-xs font-semibold text-gray-700 mb-2">Secciones disponibles:</p>
                <div class="flex flex-wrap">
                  ${seccionesInfo}
                  ${masSeccionesText}
                </div>
              </div>

              <div class="mb-3">
                <p class="text-xs text-gray-500">
                  <strong>Total de secciones:</strong> ${seccionesCurso.length}
                </p>
              </div>

              <div class="flex items-center gap-2">
                <a href="/curso/${curso.id_curso}" class="text-purple-600 hover:underline text-sm font-medium">Ver detalles</a>
                <a href="/curso/${curso.id_curso}" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 inline-flex items-center justify-center text-sm">Inscribir</a>
              </div>
            </div>
          </div>
        `;
      }).join('');
    } catch (error) {
      console.error('Error al cargar cursos:', error);
      cursosContainer.innerHTML = '<p class="text-red-500">Error al cargar cursos.</p>';
    }
  });
</script>
