---
import UsuarioHeader from '../../components/UsuarioHeader.astro';
import UsuarioLayout from '../../layouts/UsuarioLayout.astro';
---

<UsuarioLayout title="Calificaciones - Yatiña">
  <UsuarioHeader>Calificaciones</UsuarioHeader>

  <main class="flex-1 overflow-auto p-6 bg-gradient-to-br from-purple-50 to-indigo-50">
    <div class="max-w-6xl mx-auto">
      <!-- Encabezado minimalista -->
      <div class="mb-8">
        <h1 class="text-3xl font-light text-gray-900 mb-1">Mis Calificaciones</h1>
        <p class="text-sm text-gray-500">Desempeño académico</p>
      </div>

      <!-- Grid de estadísticas minimalista -->
      <div class="grid grid-cols-3 gap-4 mb-8">
        <!-- Promedio General -->
        <div class="p-6 bg-white border-l-4 border-purple-500 rounded-lg">
          <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-3">Promedio General</p>
          <div id="promedio-general" class="text-4xl font-light text-purple-600">
            <i class="fas fa-spinner fa-spin text-gray-300"></i>
          </div>
        </div>

        <!-- Cursos -->
        <div class="p-6 bg-white border-l-4 border-indigo-500 rounded-lg">
          <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-3">Cursos</p>
          <div id="total-cursos" class="text-4xl font-light text-indigo-600">
            <i class="fas fa-spinner fa-spin text-gray-300"></i>
          </div>
        </div>

        <!-- Actividades -->
        <div class="p-6 bg-white border-l-4 border-purple-600 rounded-lg">
          <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-3">Actividades</p>
          <div id="total-actividades" class="text-4xl font-light text-purple-700">
            <i class="fas fa-spinner fa-spin text-gray-300"></i>
          </div>
        </div>
      </div>

      <!-- Filtros por sección -->
      <div class="mb-6 flex gap-2 overflow-x-auto pb-2">
        <button 
          onclick="filtrarSeccion('todas')"
          class="tab-btn px-4 py-2 text-sm font-medium text-gray-700 border-b-2 border-transparent hover:border-purple-400 transition whitespace-nowrap active"
          data-seccion="todas">
          Todas
        </button>
    <div id="tabs-secciones" class="flex gap-2">
      <!-- Se cargarán dinámicamente -->
    </div>
      </div>

      <!-- Contenedor de calificaciones -->
      <div id="contenedor-calificaciones" class="space-y-6">
        <!-- Se cargará dinámicamente -->
        <div class="text-center py-12 text-gray-400">
          <i class="fas fa-spinner fa-spin text-2xl mb-3"></i>
          <p class="text-sm">Cargando...</p>
        </div>
      </div>
    </div>
  </main>
</UsuarioLayout>

<script type="module">
  import { getMatriculasByUsuario } from '../../../../public/services/matriculaService.js';
  import { obtenerNotasPorSeccion } from '../../../../public/services/notasService.js';

  let seccionesDelUsuario = [];
  let notasPorSeccion = {};
  let seccionActual = 'todas';

  // Cargar datos al iniciar
  document.addEventListener('DOMContentLoaded', async () => {
    await cargarSecciones();
    await cargarCalificaciones();
    actualizarResumen();
  });

  async function cargarSecciones() {
    try {
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      const matriculas = await getMatriculasByUsuario(user.id_usuario);

      seccionesDelUsuario = [...new Map(matriculas.map(m => [m.id_seccion, {
        id_seccion: m.id_seccion,
        nombre_seccion: m.nombre_seccion,
        nombre_curso: m.nombre_curso
      }])).values()];

      renderizarTabs();
    } catch (error) {
      console.error('Error al cargar secciones:', error);
    }
  }

  function renderizarTabs() {
    const tabsContainer = document.getElementById('tabs-secciones');
    tabsContainer.innerHTML = seccionesDelUsuario.map(seccion => `
      <button 
        onclick="filtrarSeccion(${seccion.id_seccion})"
        class="tab-btn px-4 py-2 text-sm font-medium text-gray-700 border-b-2 border-transparent hover:border-purple-400 transition whitespace-nowrap"
        data-seccion="${seccion.id_seccion}">
        ${seccion.nombre_curso}
      </button>
    `).join('');
  }

  async function cargarCalificaciones() {
    try {
      const container = document.getElementById('contenedor-calificaciones');
      container.innerHTML = `
        <div class="text-center py-12 text-gray-400">
          <i class="fas fa-spinner fa-spin text-2xl mb-3"></i>
          <p class="text-sm">Cargando...</p>
        </div>
      `;

      for (const seccion of seccionesDelUsuario) {
        try {
          const notas = await obtenerNotasPorSeccion(seccion.id_seccion);
          notasPorSeccion[seccion.id_seccion] = {
            seccion,
            notas: notas || []
          };
        } catch (error) {
          console.error(`Error al obtener notas de sección ${seccion.id_seccion}:`, error);
          notasPorSeccion[seccion.id_seccion] = {
            seccion,
            notas: []
          };
        }
      }

      actualizarVistaCalificaciones();
    } catch (error) {
      console.error('Error al cargar calificaciones:', error);
    }
  }

  window.filtrarSeccion = function(idSeccion) {
    seccionActual = idSeccion;

    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.remove('active', 'border-purple-600', 'text-purple-600');
      btn.classList.add('border-transparent');
      if ((btn.dataset.seccion === 'todas' && idSeccion === 'todas') || 
          (btn.dataset.seccion === String(idSeccion))) {
        btn.classList.add('active', 'text-purple-600', 'border-purple-600');
        btn.classList.remove('border-transparent');
      }
    });

    actualizarVistaCalificaciones();
  };

  function actualizarVistaCalificaciones() {
    const container = document.getElementById('contenedor-calificaciones');

    let seccionesAMostrar = [];
    if (seccionActual === 'todas') {
      seccionesAMostrar = seccionesDelUsuario;
    } else {
      seccionesAMostrar = seccionesDelUsuario.filter(s => s.id_seccion == seccionActual);
    }

    if (seccionesAMostrar.length === 0) {
      container.innerHTML = `
        <div class="text-center py-12 text-gray-400">
          <p class="text-sm">Sin secciones</p>
        </div>
      `;
      return;
    }

    container.innerHTML = seccionesAMostrar.map(seccion => {
      const datosSeccion = notasPorSeccion[seccion.id_seccion];
      if (!datosSeccion) return '';

      const notas = datosSeccion.notas;
      const promedioSeccion = notas.length > 0 
        ? (notas.reduce((sum, n) => sum + n.porcentaje, 0) / notas.length).toFixed(1)
        : 0;

      return `
        <div class="bg-white rounded-lg overflow-hidden border-l-4 border-purple-500 shadow-sm">
          <!-- Encabezado -->
          <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-purple-50 to-indigo-50">
            <div class="flex justify-between items-start">
              <div>
                <h3 class="text-base font-medium text-gray-900">${seccion.nombre_curso}</h3>
                <p class="text-xs text-gray-500 mt-1">${seccion.nombre_seccion}</p>
              </div>
              <div class="text-right">
                <div class="text-2xl font-light text-purple-600">${promedioSeccion}%</div>
                <p class="text-xs text-gray-500">Promedio</p>
              </div>
            </div>
          </div>

          <!-- Tabla -->
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="border-b border-gray-200 bg-gray-50">
                  <th class="px-6 py-3 text-left font-medium text-gray-700">Actividad</th>
                  <th class="px-6 py-3 text-center font-medium text-gray-700">Puntaje</th>
                  <th class="px-6 py-3 text-center font-medium text-gray-700">Porcentaje</th>
                  <th class="px-6 py-3 text-right font-medium text-gray-700">Fecha</th>
                </tr>
              </thead>
              <tbody>
                ${notas.length === 0 ? `
                  <tr>
                    <td colspan="4" class="px-6 py-8 text-center text-gray-400 text-sm">
                      Sin calificaciones
                    </td>
                  </tr>
                ` : notas.map(nota => {
                  const porcentaje = nota.porcentaje;
                  const color = porcentaje >= 90 ? 'text-green-600' :
                               porcentaje >= 80 ? 'text-blue-600' :
                               porcentaje >= 70 ? 'text-amber-600' :
                               porcentaje >= 60 ? 'text-orange-600' : 'text-red-600';

                  return `
                    <tr class="border-b border-gray-100 hover:bg-purple-50 transition">
                      <td class="px-6 py-4 text-gray-900">
                        ${nota.nombre_actividad || 'Actividad'}
                        ${nota.tipo ? `<span class="text-xs text-gray-500 ml-2">(${nota.tipo})</span>` : ''}
                      </td>
                      <td class="px-6 py-4 text-center text-gray-700 font-medium">
                        ${nota.puntaje_obtenido}/${nota.puntaje_maximo}
                      </td>
                      <td class="px-6 py-4 text-center font-medium ${color}">
                        ${porcentaje}%
                      </td>
                      <td class="px-6 py-4 text-right text-gray-500">
                        ${new Date(nota.fecha_calificacion).toLocaleDateString('es-ES')}
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }).join('');
  }

  function actualizarResumen() {
    let totalCalificaciones = 0;
    let sumaCalificaciones = 0;

    for (const seccion in notasPorSeccion) {
      const notas = notasPorSeccion[seccion].notas || [];
      totalCalificaciones += notas.length;
      sumaCalificaciones += notas.reduce((sum, n) => sum + n.porcentaje, 0);
    }

    const promedioGeneral = totalCalificaciones > 0 
      ? (sumaCalificaciones / totalCalificaciones).toFixed(1)
      : 0;

    document.getElementById('promedio-general').textContent = promedioGeneral + '%';
    document.getElementById('total-cursos').textContent = seccionesDelUsuario.length;
    document.getElementById('total-actividades').textContent = totalCalificaciones;
  }
</script>

<style>
  .tab-btn.active {
    border-bottom-color: rgb(147, 51, 234);
  }
</style>
