---
import DocenteLayout from '../../../layouts/DocenteLayout.astro';
import DocenteHeader from '../../../components/DocenteHeader.astro';
---

<DocenteLayout title="Preguntas de Actividad - Docente">
  <DocenteHeader>Gesti√≥n de Preguntas</DocenteHeader>

  <div class="flex-1 overflow-auto p-6">
    <div class="max-w-6xl mx-auto">
      <!-- Back Button -->
      <a href="/docente" class="text-purple-600 hover:text-purple-800 flex items-center mb-6">
        <span class="mr-2">‚Üê</span>
        Volver a Mis Cursos
      </a>

      <!-- Info Card -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-6 border-l-4 border-purple-600">
        <h2 class="text-2xl font-bold text-gray-800 mb-2">Actividad: <span id="actividad-titulo">Cargando...</span></h2>
        <p class="text-gray-600 mb-2">ID de Actividad: <span id="actividad-id" class="font-mono text-gray-700">--</span></p>
        <p class="text-gray-600">Tipo: <span id="actividad-tipo" class="font-semibold text-purple-600">--</span></p>
      </div>

      <!-- Add Question Button -->
      <div class="mb-6">
        <button id="btn-agregar-pregunta" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg flex items-center transition-colors">
          <span class="mr-2">+</span>
          Agregar Pregunta
        </button>
      </div>

      <!-- Questions List -->
      <div id="preguntas-container" class="space-y-4">
        <div class="text-center py-12 text-gray-500">
          <p class="text-lg">Cargando preguntas...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para agregar/editar pregunta -->
  <div id="modal-pregunta" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
      <div class="sticky top-0 bg-purple-600 text-white p-6 flex justify-between items-center">
        <h3 id="modal-titulo" class="text-xl font-bold">Nueva Pregunta</h3>
        <button id="btn-cerrar-modal" class="text-2xl font-bold hover:text-gray-200">‚úï</button>
      </div>

      <form id="form-pregunta" class="p-6 space-y-4">
        <!-- Tipo de Pregunta -->
        <div>
          <label class="block text-gray-700 font-semibold mb-2">Tipo de Pregunta</label>
          <select id="tipo-pregunta" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-600" required>
            <option value="">Selecciona un tipo</option>
            <option value="opcion">Opci√≥n M√∫ltiple</option>
            <option value="texto">Respuesta Abierta</option>
          </select>
        </div>

        <!-- Enunciado -->
        <div>
          <label class="block text-gray-700 font-semibold mb-2">Enunciado</label>
          <textarea id="enunciado" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-600 h-24" placeholder="Ingresa la pregunta..." required></textarea>
        </div>

        <!-- Puntaje -->
        <div>
          <label class="block text-gray-700 font-semibold mb-2">Puntaje</label>
          <input type="number" id="puntaje" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-600" value="1" min="1" required />
        </div>

        <!-- Opciones (solo para tipo "opcion") -->
        <div id="opciones-container" class="hidden">
          <label class="block text-gray-700 font-semibold mb-2">Opciones de Respuesta</label>
          <div id="opciones-list" class="space-y-2"></div>
          <button type="button" id="btn-agregar-opcion" class="mt-3 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center">
            <span class="mr-2">+</span>
            Agregar Opci√≥n
          </button>
        </div>

        <!-- Botones -->
        <div class="flex gap-4 mt-6">
          <button type="submit" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">
            Guardar Pregunta
          </button>
          <button type="button" id="btn-cancelar" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>
</DocenteLayout>

<script>
  import { getPreguntasPorActividad, createPregunta, deletePregunta, updatePregunta } from '../../../services/preguntaService';
  import { getActividadById } from '../../../services/actividadService';

  let id_actividad = null;
  let preguntas = [];
  let preguntaActual = null;

  // Obtener ID de la actividad de la URL
  function obtenerIdActividad() {
    // Primero intenta obtener de par√°metros query (?id=...)
    const params = new URLSearchParams(window.location.search);
    const idQuery = params.get('id');
    if (idQuery) return idQuery;
    
    // Si no est√° en query, extrae de la ruta din√°mica (/docente/preguntas/123)
    const pathSegments = window.location.pathname.split('/');
    return pathSegments[pathSegments.length - 1];
  }

  // Cargar actividad y sus preguntas
  async function cargarActividad() {
    try {
      id_actividad = obtenerIdActividad();
      
      if (!id_actividad) {
        document.getElementById('preguntas-container').innerHTML = 
          '<div class="text-red-500 text-center py-12">No se especific√≥ ID de actividad</div>';
        return;
      }

      // Obtener datos de la actividad
      const actividad = await getActividadById(id_actividad);
      document.getElementById('actividad-id').textContent = actividad.id_actividad || id_actividad;
      document.getElementById('actividad-titulo').textContent = actividad.titulo || 'Sin t√≠tulo';
      document.getElementById('actividad-tipo').textContent = actividad.tipo || '--';

      // Obtener preguntas
      preguntas = await getPreguntasPorActividad(id_actividad);
      renderizarPreguntas();
    } catch (error) {
      console.error('Error cargando actividad:', error);
      document.getElementById('preguntas-container').innerHTML = 
        `<div class="text-red-500 text-center py-12">${error.message}</div>`;
    }
  }

  // Renderizar lista de preguntas
  function renderizarPreguntas() {
    const container = document.getElementById('preguntas-container');
    
    if (preguntas.length === 0) {
      container.innerHTML = `
        <div class="text-center py-12 text-gray-500 bg-gray-50 rounded-lg">
          <p class="text-lg font-semibold">No hay preguntas a√∫n</p>
          <p class="text-sm mt-2">Haz clic en "Agregar Pregunta" para crear la primera</p>
        </div>
      `;
      return;
    }

    container.innerHTML = preguntas.map((pregunta, index) => `
      <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-purple-500 hover:shadow-lg transition-shadow">
        <div class="flex justify-between items-start mb-3">
          <div>
            <h3 class="text-lg font-bold text-gray-800">${index + 1}. ${pregunta.enunciado}</h3>
            <p class="text-sm text-gray-500 mt-1">
              Tipo: <span class="font-semibold text-purple-600">${pregunta.tipo === 'opcion' ? 'Opci√≥n M√∫ltiple' : 'Respuesta Abierta'}</span>
              | Puntaje: <span class="font-semibold">${pregunta.puntaje} pts</span>
            </p>
          </div>
          <div class="flex gap-2">
            <button class="btn-editar-pregunta text-blue-600 hover:text-blue-800 font-semibold py-1 px-3 rounded" data-id="${pregunta.id_pregunta}">
              ‚úèÔ∏è Editar
            </button>
            <button class="btn-eliminar-pregunta text-red-600 hover:text-red-800 font-semibold py-1 px-3 rounded" data-id="${pregunta.id_pregunta}">
              üóëÔ∏è Eliminar
            </button>
          </div>
        </div>

        ${pregunta.tipo === 'opcion' && pregunta.opciones ? `
          <div class="mt-4 pl-4 border-l-2 border-gray-200">
            <p class="text-sm font-semibold text-gray-700 mb-2">Opciones:</p>
            <ul class="space-y-1">
              ${pregunta.opciones.map(op => `
                <li class="text-sm text-gray-600 flex items-center">
                  <span class="mr-2">${op.es_correcta ? '‚úÖ' : '‚≠ï'}</span>
                  ${op.texto}
                </li>
              `).join('')}
            </ul>
          </div>
        ` : ''}
      </div>
    `).join('');

    // Agregar eventos a botones
    document.querySelectorAll('.btn-editar-pregunta').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = e.target.closest('button').dataset.id;
        const pregunta = preguntas.find(p => p.id_pregunta == id);
        abrirModalPregunta(pregunta);
      });
    });

    document.querySelectorAll('.btn-eliminar-pregunta').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const id = e.target.closest('button').dataset.id;
        if (confirm('¬øEst√°s seguro de que deseas eliminar esta pregunta?')) {
          try {
            await deletePregunta(id);
            preguntas = preguntas.filter(p => p.id_pregunta != id);
            renderizarPreguntas();
            alert('Pregunta eliminada correctamente');
          } catch (error) {
            alert('Error al eliminar: ' + error.message);
          }
        }
      });
    });
  }

  // Modal y formulario
  const modal = document.getElementById('modal-pregunta');
  const formPregunta = document.getElementById('form-pregunta');
  const tipoSelect = document.getElementById('tipo-pregunta');
  const opcionesContainer = document.getElementById('opciones-container');
  const opcionesList = document.getElementById('opciones-list');
  const btnAgregarOpcion = document.getElementById('btn-agregar-opcion');
  const btnAbrirModal = document.getElementById('btn-agregar-pregunta');
  const btnCerrarModal = document.getElementById('btn-cerrar-modal');
  const btnCancelar = document.getElementById('btn-cancelar');

  btnAbrirModal.addEventListener('click', () => abrirModalPregunta());
  btnCerrarModal.addEventListener('click', () => cerrarModal());
  btnCancelar.addEventListener('click', () => cerrarModal());

  tipoSelect.addEventListener('change', (e) => {
    if (e.target.value === 'opcion') {
      opcionesContainer.classList.remove('hidden');
      if (opcionesList.children.length === 0) {
        agregarOpcion();
        agregarOpcion();
      }
    } else {
      opcionesContainer.classList.add('hidden');
    }
  });

  btnAgregarOpcion.addEventListener('click', agregarOpcion);

  function agregarOpcion() {
    const opcionDiv = document.createElement('div');
    opcionDiv.className = 'flex gap-2 items-center p-3 bg-gray-50 rounded-lg';
    opcionDiv.innerHTML = `
      <input type="text" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg" placeholder="Ingresa la opci√≥n..." required />
      <label class="flex items-center gap-2">
        <input type="checkbox" class="w-4 h-4" />
        <span class="text-sm">Correcta</span>
      </label>
      <button type="button" class="btn-eliminar-opcion text-red-600 hover:text-red-800 font-bold">‚úï</button>
    `;
    opcionesList.appendChild(opcionDiv);

    opcionDiv.querySelector('.btn-eliminar-opcion').addEventListener('click', () => {
      opcionDiv.remove();
    });
  }

  function abrirModalPregunta(pregunta = null) {
    preguntaActual = pregunta;
    document.getElementById('modal-titulo').textContent = pregunta ? 'Editar Pregunta' : 'Nueva Pregunta';
    
    if (pregunta) {
      document.getElementById('tipo-pregunta').value = pregunta.tipo;
      document.getElementById('enunciado').value = pregunta.enunciado;
      document.getElementById('puntaje').value = pregunta.puntaje;

      if (pregunta.tipo === 'opcion') {
        opcionesContainer.classList.remove('hidden');
        opcionesList.innerHTML = '';
        if (pregunta.opciones) {
          pregunta.opciones.forEach(op => {
            const opcionDiv = document.createElement('div');
            opcionDiv.className = 'flex gap-2 items-center p-3 bg-gray-50 rounded-lg';
            opcionDiv.innerHTML = `
              <input type="text" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg" value="${op.texto}" required />
              <label class="flex items-center gap-2">
                <input type="checkbox" class="w-4 h-4" ${op.es_correcta ? 'checked' : ''} />
                <span class="text-sm">Correcta</span>
              </label>
              <button type="button" class="btn-eliminar-opcion text-red-600 hover:text-red-800 font-bold">‚úï</button>
            `;
            opcionesList.appendChild(opcionDiv);

            opcionDiv.querySelector('.btn-eliminar-opcion').addEventListener('click', () => {
              opcionDiv.remove();
            });
          });
        }
      }
    } else {
      formPregunta.reset();
      opcionesContainer.classList.add('hidden');
      opcionesList.innerHTML = '';
    }

    modal.classList.remove('hidden');
  }

  function cerrarModal() {
    modal.classList.add('hidden');
    preguntaActual = null;
    formPregunta.reset();
  }

  formPregunta.addEventListener('submit', async (e) => {
    e.preventDefault();

    const tipo = document.getElementById('tipo-pregunta').value;
    const enunciado = document.getElementById('enunciado').value;
    const puntaje = parseInt(document.getElementById('puntaje').value);

    let opciones = [];
    if (tipo === 'opcion') {
      opciones = Array.from(opcionesList.querySelectorAll('div')).map(div => ({
        texto: div.querySelector('input[type="text"]').value,
        es_correcta: div.querySelector('input[type="checkbox"]').checked
      }));

      if (opciones.length === 0) {
        alert('Debes agregar al menos una opci√≥n');
        return;
      }
    }

    try {
      const datos = { id_actividad, tipo, enunciado, puntaje };
      if (tipo === 'opcion') datos.opciones = opciones;

      if (preguntaActual) {
        await updatePregunta(preguntaActual.id_pregunta, datos);
        alert('Pregunta actualizada correctamente');
      } else {
        await createPregunta(datos);
        alert('Pregunta creada correctamente');
      }

      cerrarModal();
      cargarActividad();
    } catch (error) {
      alert('Error: ' + error.message);
    }
  });

  // Cargar al iniciar
  cargarActividad();
</script>

<style>
  .btn-eliminar-opcion:hover {
    background-color: rgba(239, 68, 68, 0.1);
    padding: 4px 8px;
    border-radius: 4px;
  }
</style>
