<div id="responderActividadContainer" class="hidden">
  <div class="max-w-4xl mx-auto p-6">
    <!-- Header -->
    <div class="mb-8 p-6 bg-gradient-to-r from-blue-600 to-blue-800 text-white rounded-lg shadow-lg">
      <h1 id="actividadTitulo" class="text-3xl font-bold mb-2">-</h1>
      <p id="actividadDescripcion" class="text-blue-100 mb-4">-</p>
      <div class="flex justify-between items-center">
        <div>
          <p class="text-sm"><strong>Tipo:</strong> <span id="actividadTipo" class="badge">-</span></p>
          <p class="text-sm"><strong>Puntaje MÃ¡ximo:</strong> <span id="actividadPuntaje">0</span></p>
        </div>
        <div>
          <p class="text-sm"><strong>Fecha Entrega:</strong> <span id="actividadFecha">-</span></p>
          <p class="text-sm"><strong>Progreso:</strong> <span id="progreso">0/0</span></p>
        </div>
      </div>
    </div>

    <!-- Preguntas -->
    <div id="preguntasContainer" class="space-y-6 mb-8">
      <!-- Las preguntas se cargarÃ¡n aquÃ­ -->
    </div>

    <!-- Botones de acciÃ³n -->
    <div class="flex justify-between items-center mt-8">
      <button id="guardarBorrador" class="px-6 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition">
        ðŸ’¾ Guardar Borrador
      </button>
      <div class="flex gap-3">
        <button id="cancelarRespuesta" class="px-6 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500 transition">
          Cancelar
        </button>
        <button id="enviarRespuestas" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
          âœ“ Enviar Respuestas
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  .pregunta-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 1.5rem;
    margin-bottom: 1rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .pregunta-titulo {
    font-size: 1.1rem;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 0.5rem;
  }

  .pregunta-numero {
    display: inline-block;
    background: #3b82f6;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    margin-right: 0.5rem;
    font-weight: bold;
  }

  .opcion-multiple {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    margin: 0.5rem 0;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .opcion-multiple:hover {
    background: #f3f4f6;
    border-color: #3b82f6;
  }

  .opcion-multiple input[type="radio"],
  .opcion-multiple input[type="checkbox"] {
    margin-right: 0.75rem;
    cursor: pointer;
  }

  .respuesta-texto {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    font-family: inherit;
    resize: vertical;
  }

  .respuesta-texto:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 0.25rem;
    font-size: 0.875rem;
    font-weight: 500;
  }

  .alerta {
    padding: 1rem;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
  }

  .alerta-info {
    background: #dbeafe;
    color: #0c4a6e;
    border-left: 4px solid #0284c7;
  }

  .alerta-exito {
    background: #dcfce7;
    color: #166534;
    border-left: 4px solid #22c55e;
  }

  .alerta-error {
    background: #fee2e2;
    color: #7f1d1d;
    border-left: 4px solid #ef4444;
  }
</style>

<script>
  import { 
    getPreguntasByActividad, 
    enviarRespuesta,
    getRespuestasAlumnoActividad 
  } from '/services/moduloService.js';

  let id_actividad = null;
  let id_matricula = null;
  let respuestas = {}; // Almacenar respuestas temporalmente

  const container = document.getElementById('responderActividadContainer');
  const preguntasContainer = document.getElementById('preguntasContainer');
  const guardarBorradorBtn = document.getElementById('guardarBorrador');
  const cancelarBtn = document.getElementById('cancelarRespuesta');
  const enviarBtn = document.getElementById('enviarRespuestas');
  const progresoSpan = document.getElementById('progreso');

  // Cargar preguntas
  async function cargarPreguntas() {
    try {
      const preguntas = await getPreguntasByActividad(id_actividad);
      renderizarPreguntas(preguntas);
      progresoSpan.textContent = `0/${preguntas.length}`;

      // Cargar respuestas guardadas si existen
      try {
        const respuestasGuardadas = await getRespuestasAlumnoActividad(id_actividad, id_matricula);
        if (respuestasGuardadas.data && respuestasGuardadas.data.length > 0) {
          respuestasGuardadas.data.forEach(r => {
            if (r.id_opcion) {
              document.querySelector(`input[value="${r.id_opcion}"]`)?.click();
            } else if (r.respuesta_texto) {
              const textarea = document.querySelector(`textarea[data-pregunta-id="${r.id_pregunta}"]`);
              if (textarea) textarea.value = r.respuesta_texto;
            }
          });
        }
      } catch (e) {
        console.log('Sin respuestas guardadas previas');
      }
    } catch (error) {
      console.error('Error cargando preguntas:', error);
      mostrarAlerta('Error al cargar preguntas', 'error');
    }
  }

  function renderizarPreguntas(preguntas) {
    preguntasContainer.innerHTML = '';
    preguntas.forEach((preg, idx) => {
      const div = document.createElement('div');
      div.className = 'pregunta-card';
      
      if (preg.tipo === 'opcion') {
        // OpciÃ³n mÃºltiple
        div.innerHTML = `
          <div class="pregunta-titulo">
            <span class="pregunta-numero">Pregunta ${idx + 1}</span>
            ${preg.enunciado}
          </div>
          ${preg.opciones ? preg.opciones.map((op, opIdx) => `
            <label class="opcion-multiple">
              <input type="radio" name="pregunta_${preg.id_pregunta}" value="${op.id_opcion}" />
              ${op.texto}
            </label>
          `).join('') : ''}
        `;
      } else {
        // Respuesta de texto
        div.innerHTML = `
          <div class="pregunta-titulo">
            <span class="pregunta-numero">Pregunta ${idx + 1}</span>
            ${preg.enunciado}
          </div>
          <textarea 
            class="respuesta-texto" 
            data-pregunta-id="${preg.id_pregunta}"
            placeholder="Escribe tu respuesta..."
            rows="4"
          ></textarea>
        `;
      }

      preguntasContainer.appendChild(div);

      // Rastrear cambios
      const inputs = div.querySelectorAll('input[type="radio"], textarea');
      inputs.forEach(input => {
        input.addEventListener('change', () => {
          respuestas[preg.id_pregunta] = {
            id_pregunta: preg.id_pregunta,
            tipo: preg.tipo
          };
          actualizarProgreso(preguntas);
        });
      });
    });
  }

  function actualizarProgreso(preguntas) {
    const respondidas = Object.keys(respuestas).length;
    progresoSpan.textContent = `${respondidas}/${preguntas.length}`;
  }

  // Guardar borrador
  guardarBorradorBtn?.addEventListener('click', async () => {
    try {
      const preguntasElements = document.querySelectorAll('.pregunta-card');
      let guardadas = 0;

      for (const card of preguntasElements) {
        const radioInput = card.querySelector('input[type="radio"]:checked');
        const textarea = card.querySelector('textarea');

        if (radioInput) {
          const id_pregunta = parseInt(radioInput.name.split('_')[1]);
          await enviarRespuesta({
            id_actividad,
            id_pregunta,
            id_matricula,
            id_opcion: parseInt(radioInput.value)
          });
          guardadas++;
        } else if (textarea && textarea.value.trim()) {
          const id_pregunta = parseInt(textarea.dataset.preguntaId);
          await enviarRespuesta({
            id_actividad,
            id_pregunta,
            id_matricula,
            respuesta_texto: textarea.value
          });
          guardadas++;
        }
      }

      mostrarAlerta(`Borrador guardado (${guardadas} respuestas)`, 'exito');
    } catch (error) {
      console.error('Error guardando borrador:', error);
      mostrarAlerta('Error al guardar borrador', 'error');
    }
  });

  // Enviar respuestas
  enviarBtn?.addEventListener('click', async () => {
    const confirmado = confirm('Â¿EstÃ¡s seguro de que deseas enviar tus respuestas? No podrÃ¡s cambiarlas despuÃ©s.');
    if (!confirmado) return;

    try {
      const preguntasElements = document.querySelectorAll('.pregunta-card');
      let enviadas = 0;

      for (const card of preguntasElements) {
        const radioInput = card.querySelector('input[type="radio"]:checked');
        const textarea = card.querySelector('textarea');

        if (radioInput) {
          const id_pregunta = parseInt(radioInput.name.split('_')[1]);
          await enviarRespuesta({
            id_actividad,
            id_pregunta,
            id_matricula,
            id_opcion: parseInt(radioInput.value)
          });
          enviadas++;
        } else if (textarea && textarea.value.trim()) {
          const id_pregunta = parseInt(textarea.dataset.preguntaId);
          await enviarRespuesta({
            id_actividad,
            id_pregunta,
            id_matricula,
            respuesta_texto: textarea.value
          });
          enviadas++;
        }
      }

      mostrarAlerta(`Respuestas enviadas correctamente (${enviadas} respuestas)`, 'exito');
      setTimeout(() => {
        window.history.back();
      }, 2000);
    } catch (error) {
      console.error('Error enviando respuestas:', error);
      mostrarAlerta('Error al enviar respuestas', 'error');
    }
  });

  // Cancelar
  cancelarBtn?.addEventListener('click', () => {
    if (confirm('Â¿Descartar cambios?')) {
      window.history.back();
    }
  });

  function mostrarAlerta(mensaje, tipo) {
    const div = document.createElement('div');
    div.className = `alerta alerta-${tipo}`;
    div.textContent = mensaje;
    preguntasContainer.insertBefore(div, preguntasContainer.firstChild);
    setTimeout(() => div.remove(), 5000);
  }

  // Exponer funciÃ³n para inicializar
  window.iniciarResponderActividad = (actId, matriculaId) => {
    id_actividad = actId;
    id_matricula = matriculaId;
    container.classList.remove('hidden');
    cargarPreguntas();
  };
</script>
