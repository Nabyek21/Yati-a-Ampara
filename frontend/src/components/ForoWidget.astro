---
// ForoWidget.astro
// Widget para mostrar el foro de la sección
// Permite crear temas, ver respuestas y comunicarse con otros usuarios
---

<div id="foro-widget" class="bg-white rounded-lg shadow-md p-6">
  <div class="flex justify-between items-center mb-6 pb-4 border-b">
    <h2 class="text-2xl font-bold text-gray-800">
      <i class="fas fa-comments mr-2 text-blue-600"></i>
      Foro de Discusión
    </h2>
    <button id="foro-btn-nuevo-tema" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 flex items-center gap-2">
      <i class="fas fa-plus"></i>
      Nuevo Tema
    </button>
  </div>

  <!-- Tabs: Temas vs Mis Participaciones -->
  <div class="flex gap-4 mb-6 border-b">
    <button id="foro-tab-temas" class="px-4 py-2 border-b-2 border-blue-600 text-blue-600 font-semibold">
      <i class="fas fa-list mr-2"></i>Todos los Temas
    </button>
    <button id="foro-tab-participaciones" class="px-4 py-2 border-b-2 border-transparent text-gray-600 hover:text-gray-800">
      <i class="fas fa-user-check mr-2"></i>Mis Participaciones
    </button>
  </div>

  <!-- Lista de Temas -->
  <div id="foro-lista-temas" class="space-y-3 mb-6">
    <div class="text-center py-8 text-gray-500">
      <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
      <p>Cargando temas...</p>
    </div>
  </div>

  <!-- Paginación -->
  <div id="foro-paginacion" class="flex justify-center gap-2 mt-6">
    <!-- Se llenará dinámicamente -->
  </div>
</div>

<!-- Modal para ver detalles de tema -->
<div id="foro-modal-tema" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-10 mx-auto p-6 border w-full max-w-4xl shadow-lg rounded-md bg-white">
    <div class="flex justify-between items-center pb-4 border-b mb-4">
      <h3 class="text-2xl font-bold text-gray-900" id="foro-modal-titulo">Tema</h3>
      <button id="foro-cerrar-modal" class="text-gray-400 hover:text-gray-600">
        <i class="fas fa-times text-2xl"></i>
      </button>
    </div>

    <!-- Información del tema -->
    <div class="bg-blue-50 rounded-lg p-4 mb-6 border border-blue-200">
      <p class="text-gray-700 mb-3" id="foro-modal-descripcion">-</p>
      <div class="flex justify-between items-center text-sm text-gray-600">
        <span id="foro-modal-autor">Por: -</span>
        <span id="foro-modal-fecha">-</span>
        <span id="foro-modal-respuestas" class="font-semibold text-blue-600">0 respuestas</span>
      </div>
    </div>

    <!-- Lista de respuestas -->
    <div class="bg-gray-50 rounded-lg p-4 mb-6 max-h-96 overflow-y-auto border">
      <h4 class="font-semibold text-gray-800 mb-4">Respuestas</h4>
      <div id="foro-modal-respuestas-lista" class="space-y-4">
        <p class="text-gray-500 text-center py-4">Cargando respuestas...</p>
      </div>
    </div>

    <!-- Formulario para nueva respuesta -->
    <div class="border-t pt-4">
      <h4 class="font-semibold text-gray-800 mb-3">Tu Respuesta</h4>
      <form id="foro-forma-respuesta" class="space-y-3">
        <textarea
          id="foro-textarea-respuesta"
          placeholder="Escribe tu respuesta aquí..."
          rows="4"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          required
        ></textarea>
        <div class="flex justify-end gap-2">
          <button type="button" id="foro-btn-cerrar-form" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
            Cancelar
          </button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
            <i class="fas fa-paper-plane mr-1"></i>Enviar Respuesta
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal para crear nuevo tema -->
<div id="foro-modal-nuevo-tema" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-20 mx-auto p-6 border w-full max-w-2xl shadow-lg rounded-md bg-white">
    <div class="flex justify-between items-center pb-4 border-b mb-4">
      <h3 class="text-2xl font-bold text-gray-900">Crear Nuevo Tema</h3>
      <button id="foro-cerrar-modal-nuevo" class="text-gray-400 hover:text-gray-600">
        <i class="fas fa-times text-2xl"></i>
      </button>
    </div>

    <form id="foro-forma-nuevo-tema" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Título del Tema</label>
        <input
          type="text"
          id="foro-input-titulo"
          placeholder="Ej: Duda sobre el módulo 3"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          required
        />
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Descripción</label>
        <textarea
          id="foro-textarea-descripcion"
          placeholder="Describe tu pregunta o tema de discusión..."
          rows="5"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          required
        ></textarea>
      </div>

      <div class="flex justify-end gap-2 pt-4 border-t">
        <button type="button" id="foro-btn-cancelar-nuevo" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
          Cancelar
        </button>
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
          <i class="fas fa-plus mr-1"></i>Crear Tema
        </button>
      </div>
    </form>
  </div>
</div>

<script type="module">
  import {
    obtenerTemasPorSeccion,
    obtenerTemaPorId,
    obtenerRespuestasPorTema,
    crearTema,
    crearRespuesta,
    eliminarTema,
    eliminarRespuesta
  } from '../../../../public/services/foroService.js';

  let idSeccionActual = null;
  let temaActual = null;
  let paginaActual = 1;
  const itemsPorPagina = 10;

  // ============ INICIALIZACIÓN ============

  document.addEventListener('DOMContentLoaded', () => {
    // Obtener id_seccion del sessionStorage o parámetro
    idSeccionActual = parseInt(sessionStorage.getItem('id_seccion')) || 1;
    cargarTemas();
    setupEventListeners();
  });

  // ============ EVENT LISTENERS ============

  function setupEventListeners() {
    // Botón nuevo tema
    document.getElementById('foro-btn-nuevo-tema')?.addEventListener('click', () => {
      document.getElementById('foro-modal-nuevo-tema').classList.remove('hidden');
    });

    // Cerrar modales
    document.getElementById('foro-cerrar-modal')?.addEventListener('click', () => {
      document.getElementById('foro-modal-tema').classList.add('hidden');
    });

    document.getElementById('foro-cerrar-modal-nuevo')?.addEventListener('click', () => {
      document.getElementById('foro-modal-nuevo-tema').classList.add('hidden');
    });

    document.getElementById('foro-btn-cerrar-form')?.addEventListener('click', () => {
      document.getElementById('foro-forma-respuesta').reset();
    });

    document.getElementById('foro-btn-cancelar-nuevo')?.addEventListener('click', () => {
      document.getElementById('foro-modal-nuevo-tema').classList.add('hidden');
      document.getElementById('foro-forma-nuevo-tema').reset();
    });

    // Tabs
    document.getElementById('foro-tab-temas')?.addEventListener('click', cargarTemas);
    document.getElementById('foro-tab-participaciones')?.addEventListener('click', cargarParticipaciones);

    // Formularios
    document.getElementById('foro-forma-nuevo-tema')?.addEventListener('submit', handleCrearTema);
    document.getElementById('foro-forma-respuesta')?.addEventListener('submit', handleCrearRespuesta);
  }

  // ============ FUNCIONES PRINCIPALES ============

  async function cargarTemas() {
    try {
      const temas = await obtenerTemasPorSeccion(idSeccionActual, itemsPorPagina, 0);
      renderizarTemas(temas);
      actualizarTabs('temas');
    } catch (error) {
      console.error('Error al cargar temas:', error);
      document.getElementById('foro-lista-temas').innerHTML = `
        <div class="text-center py-8 text-red-500">
          <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
          <p>Error al cargar los temas</p>
        </div>
      `;
    }
  }

  async function cargarParticipaciones() {
    // Por ahora, mostrar los mismos temas (implementar filtrado después)
    cargarTemas();
    actualizarTabs('participaciones');
  }

  function renderizarTemas(temas) {
    const lista = document.getElementById('foro-lista-temas');

    if (temas.length === 0) {
      lista.innerHTML = `
        <div class="text-center py-8 text-gray-500">
          <i class="fas fa-comments text-3xl mb-2 opacity-50"></i>
          <p>No hay temas en esta sección</p>
          <p class="text-sm">Sé el primero en crear uno</p>
        </div>
      `;
      return;
    }

    lista.innerHTML = temas.map(tema => `
      <div class="border rounded-lg p-4 hover:bg-blue-50 cursor-pointer transition" onclick="abrirTema(${tema.id_tema})">
        <div class="flex justify-between items-start mb-2">
          <h3 class="text-lg font-semibold text-gray-900">${tema.titulo}</h3>
          <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs font-semibold rounded">
            ${tema.total_respuestas} respuestas
          </span>
        </div>
        <p class="text-gray-600 text-sm mb-2 line-clamp-2">${tema.descripcion}</p>
        <div class="flex justify-between items-center text-xs text-gray-500">
          <span>Por: <strong>${tema.nombres} ${tema.apellidos}</strong></span>
          <span>${new Date(tema.fecha_creacion).toLocaleDateString('es-ES')}</span>
        </div>
      </div>
    `).join('');
  }

  window.abrirTema = async function(idTema) {
    try {
      const tema = await obtenerTemaPorId(idTema);
      const respuestas = await obtenerRespuestasPorTema(idTema);

      temaActual = tema;

      // Llenar información del tema
      document.getElementById('foro-modal-titulo').textContent = tema.titulo;
      document.getElementById('foro-modal-descripcion').textContent = tema.descripcion;
      document.getElementById('foro-modal-autor').textContent = `Por: ${tema.nombres} ${tema.apellidos}`;
      document.getElementById('foro-modal-fecha').textContent = new Date(tema.fecha_creacion).toLocaleDateString('es-ES');
      document.getElementById('foro-modal-respuestas').textContent = `${respuestas.length} ${respuestas.length === 1 ? 'respuesta' : 'respuestas'}`;

      // Llenar respuestas
      renderizarRespuestas(respuestas);

      document.getElementById('foro-modal-tema').classList.remove('hidden');
    } catch (error) {
      console.error('Error al abrir tema:', error);
      alert('Error al cargar el tema');
    }
  };

  function renderizarRespuestas(respuestas) {
    const lista = document.getElementById('foro-modal-respuestas-lista');

    if (respuestas.length === 0) {
      lista.innerHTML = '<p class="text-gray-500 text-center py-4">Aún no hay respuestas. Sé el primero en responder.</p>';
      return;
    }

    lista.innerHTML = respuestas.map(resp => `
      <div class="bg-white p-3 rounded border-l-4 border-blue-500">
        <div class="flex justify-between items-start mb-2">
          <strong class="text-gray-900">${resp.nombres} ${resp.apellidos}</strong>
          <span class="text-xs text-gray-500">${new Date(resp.fecha_creacion).toLocaleDateString('es-ES')}</span>
        </div>
        <p class="text-gray-700">${resp.contenido}</p>
      </div>
    `).join('');
  }

  // ============ FORMULARIOS ============

  async function handleCrearTema(e) {
    e.preventDefault();

    const titulo = document.getElementById('foro-input-titulo').value;
    const descripcion = document.getElementById('foro-textarea-descripcion').value;

    try {
      await crearTema(idSeccionActual, titulo, descripcion);
      document.getElementById('foro-modal-nuevo-tema').classList.add('hidden');
      document.getElementById('foro-forma-nuevo-tema').reset();
      cargarTemas();
      alert('Tema creado exitosamente');
    } catch (error) {
      console.error('Error al crear tema:', error);
      alert('Error al crear el tema');
    }
  }

  async function handleCrearRespuesta(e) {
    e.preventDefault();

    const contenido = document.getElementById('foro-textarea-respuesta').value;

    try {
      await crearRespuesta(temaActual.id_tema, contenido);
      document.getElementById('foro-forma-respuesta').reset();
      
      // Recargar tema
      window.abrirTema(temaActual.id_tema);
      alert('Respuesta enviada exitosamente');
    } catch (error) {
      console.error('Error al crear respuesta:', error);
      alert('Error al enviar la respuesta');
    }
  }

  // ============ UTILIDADES ============

  function actualizarTabs(tab) {
    const btnTemas = document.getElementById('foro-tab-temas');
    const btnParticipaciones = document.getElementById('foro-tab-participaciones');

    if (tab === 'temas') {
      btnTemas.classList.add('border-blue-600', 'text-blue-600');
      btnTemas.classList.remove('border-transparent', 'text-gray-600');
      btnParticipaciones.classList.add('border-transparent', 'text-gray-600');
      btnParticipaciones.classList.remove('border-blue-600', 'text-blue-600');
    } else {
      btnParticipaciones.classList.add('border-blue-600', 'text-blue-600');
      btnParticipaciones.classList.remove('border-transparent', 'text-gray-600');
      btnTemas.classList.add('border-transparent', 'text-gray-600');
      btnTemas.classList.remove('border-blue-600', 'text-blue-600');
    }
  }
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
