---
import DocenteLayout from '../layouts/DocenteLayout.astro';
import DocenteHeader from '../components/DocenteHeader.astro';
---

<DocenteLayout title="Dashboard Docente - YatiÃ±a">
  <DocenteHeader>Mis Cursos</DocenteHeader>
  <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
    <!-- SecciÃ³n de Bienvenida -->
    <div class="bg-purple-600 rounded-lg shadow-lg p-6 mb-6 text-white">
      <h2 class="text-2xl font-bold mb-2">Â¡Bienvenida de nuevo, <span id="docente-nombre">Prof. Rivera</span>!</h2>
      <p class="text-purple-100 mb-4">AquÃ­ tienes un resumen de tu actividad docente.</p>
      
      <!-- Tarjetas de Resumen -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
        <div class="bg-purple-700 rounded-lg p-4 flex items-center space-x-3">
          <div class="bg-purple-800 rounded-full p-3">
            <i class="fas fa-desktop text-2xl"></i>
          </div>
          <div>
            <p class="text-2xl font-bold" id="cursos-cargo">0</p>
            <p class="text-sm text-purple-200">Cursos a Cargo</p>
          </div>
        </div>
        
        <div class="bg-purple-700 rounded-lg p-4 flex items-center space-x-3">
          <div class="bg-purple-800 rounded-full p-3">
            <i class="fas fa-users text-2xl"></i>
          </div>
          <div>
            <p class="text-2xl font-bold" id="estudiantes-totales">0</p>
            <p class="text-sm text-purple-200">Estudiantes Totales</p>
          </div>
        </div>
        
        <div class="bg-purple-700 rounded-lg p-4 flex items-center space-x-3">
          <div class="bg-purple-800 rounded-full p-3">
            <i class="fas fa-pen text-2xl"></i>
          </div>
          <div>
            <p class="text-2xl font-bold" id="tareas-calificar">0</p>
            <p class="text-sm text-purple-200">Tareas por Calificar</p>
          </div>
        </div>
      </div>
    </div>

    <!-- SecciÃ³n de Cursos -->
    <div class="mb-6">
      <h3 class="text-2xl font-bold text-purple-800 mb-4">Mis cursos a cargo</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="cursos-container">
        <!-- Los cursos se cargarÃ¡n dinÃ¡micamente -->
        <div class="text-center text-gray-500 py-8">
          <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
          <p>Cargando cursos...</p>
        </div>
      </div>
    </div>
  </main>
</DocenteLayout>

<script type="module">
  import { getSecciones } from '../services/seccionService.js';
  import { getTareasPorCalificarSeccion } from '../public/services/estadisticasService.js';

  document.addEventListener('DOMContentLoaded', async () => {
    // Obtener nombre del docente
    const user = localStorage.getItem('user');
    let id_docente_perfil = null;
    
    if (user) {
      const userData = JSON.parse(user);
      const nombreCompleto = `Prof. ${userData.nombres} ${userData.apellidos}`;
      document.getElementById('docente-nombre').textContent = nombreCompleto;
      id_docente_perfil = userData.id_docente_perfil;
      console.log('ðŸ‘¤ ID Docente Perfil:', id_docente_perfil);
    }

    // Cargar secciones del docente
    try {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/login';
        return;
      }

      // Obtener secciones filtrando por id_docente_perfil
      const secciones = id_docente_perfil 
        ? await getSecciones({ id_docente_perfil })
        : [];
      
      console.log(`âœ… Secciones asignadas al docente ${id_docente_perfil}:`, secciones);
      console.log('ðŸ” Detalles de secciones:', secciones.map(s => ({
        id_seccion: s.id_seccion,
        nombre_seccion: s.nombre_seccion,
        id_docente_perfil: s.id_docente_perfil,
        id_curso: s.id_curso
      })));
      
      const cursosContainer = document.getElementById('cursos-container');
      
      if (secciones.length === 0) {
        cursosContainer.innerHTML = `
          <div class="col-span-full bg-white rounded-lg shadow p-6">
            <p class="text-gray-500 text-center">No hay cursos asignados aÃºn</p>
          </div>
        `;
        return;
      }

      // Agrupar secciones por curso
      const cursosMap = new Map();
      secciones.forEach(seccion => {
        if (!cursosMap.has(seccion.id_curso)) {
          cursosMap.set(seccion.id_curso, {
            id_curso: seccion.id_curso,
            nombre_curso: seccion.nombre_curso,
            secciones: []
          });
        }
        cursosMap.get(seccion.id_curso).secciones.push(seccion);
      });

      cursosContainer.innerHTML = Array.from(cursosMap.values()).map(curso => {
        const totalEstudiantes = curso.secciones.reduce((sum, s) => {
          const count = s.total_estudiantes || 0;
          console.log(`SecciÃ³n ${s.nombre_seccion}: ${count} estudiantes`);
          return sum + count;
        }, 0);
        
        // Nota: tareasPorCalificar se calcularÃ¡ dinÃ¡micamente ahora
        let tareasPorCalificar = 0;
        
        // InformaciÃ³n de secciones
        const seccionesInfo = curso.secciones.map(s => ({
          nombre: s.nombre_seccion,
          id_seccion: s.id_seccion,
          estudiantes: s.total_estudiantes || 0,
          horario: s.horario || 'No definido',
          inicio: s.fecha_inicio,
          fin: s.fecha_fin,
          modalidad: s.nombre_modalidad
        }));
        
        // Formatear fechas
        const formatFecha = (fecha) => {
          if (!fecha) return 'N/A';
          return new Date(fecha).toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: '2-digit' });
        };
        
        // HTML de secciones
        const seccionesHTML = seccionesInfo.map(s => `
          <div class="flex items-center justify-between p-3 bg-purple-50 rounded-lg border border-purple-200">
            <div class="flex-1">
              <p class="font-medium text-sm text-gray-800">${s.nombre}</p>
              <div class="flex items-center gap-3 text-xs text-gray-600 mt-1">
                <span><i class="fas fa-users mr-1"></i>${s.estudiantes} est.</span>
                <span><i class="fas fa-clock mr-1"></i>${s.horario}</span>
              </div>
            </div>
            <span class="px-2 py-1 bg-purple-200 text-purple-800 rounded text-xs font-medium">${s.modalidad}</span>
          </div>
        `).join('');
        
        const fechaInicio = formatFecha(seccionesInfo[0]?.inicio);
        const fechaFin = formatFecha(seccionesInfo[0]?.fin);
        
        return `
          <div class="bg-white rounded-lg shadow hover:shadow-xl transition-shadow border-l-4 border-purple-600">
            <div class="p-6">
              <!-- Encabezado -->
              <div class="flex justify-between items-start mb-4">
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-2">
                    <i class="fas fa-book text-purple-600 text-xl"></i>
                    <h4 class="text-lg font-bold text-gray-800">${curso.nombre_curso}</h4>
                  </div>
                  <p class="text-xs text-gray-500 italic">ID Curso: ${curso.id_curso}</p>
                </div>
              </div>

              <!-- Secciones asignadas -->
              <div class="mb-4">
                <p class="text-xs font-semibold text-gray-700 uppercase mb-2">
                  <i class="fas fa-layer-group mr-1"></i>Secciones (${seccionesInfo.length})
                </p>
                <div class="space-y-2">
                  ${seccionesHTML}
                </div>
              </div>

              <!-- Fechas -->
              <div class="grid grid-cols-2 gap-3 mb-4 py-3 border-t border-b border-gray-200">
                <div>
                  <p class="text-xs text-gray-600">Inicio</p>
                  <p class="text-sm font-semibold text-gray-800">ðŸ“… ${fechaInicio}</p>
                </div>
                <div>
                  <p class="text-xs text-gray-600">Fin</p>
                  <p class="text-sm font-semibold text-gray-800">ðŸ“… ${fechaFin}</p>
                </div>
              </div>

              <!-- EstadÃ­sticas -->
              <div class="grid grid-cols-3 gap-2 mb-4">
                <div class="bg-blue-50 rounded p-3 text-center">
                  <p class="text-2xl font-bold text-blue-600">${totalEstudiantes}</p>
                  <p class="text-xs text-gray-600">Estudiantes</p>
                </div>
                <div class="bg-orange-50 rounded p-3 text-center">
                  <p class="text-2xl font-bold text-orange-600" id="tareas-${curso.id_curso}">...</p>
                  <p class="text-xs text-gray-600">Por Calificar</p>
                </div>
                <div class="bg-purple-50 rounded p-3 text-center">
                  <p class="text-2xl font-bold text-purple-600">${seccionesInfo.length}</p>
                  <p class="text-xs text-gray-600">Secciones</p>
                </div>
              </div>

              <!-- Acciones -->
              <div class="flex gap-2">
                <a href="/docente/curso/${curso.id_curso}" class="flex-1 inline-flex items-center justify-center px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-medium text-sm">
                  <i class="fas fa-book mr-2"></i>Ver MÃ³dulos
                </a>
                <a href="/docente/estudiantes/${curso.id_curso}" class="flex-1 inline-flex items-center justify-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium text-sm">
                  <i class="fas fa-users mr-2"></i>Estudiantes
                </a>
              </div>
            </div>
          </div>
        `;
      }).join('');

      // Cargar tareas por calificar dinÃ¡micamente para cada secciÃ³n
      for (const curso of cursosMap.values()) {
        for (const seccion of curso.secciones) {
          try {
            const estadisticas = await getTareasPorCalificarSeccion(seccion.id_seccion);
            const tareasPorCalificar = estadisticas.tareas_por_calificar || 0;
            
            // Actualizar el elemento
            const elemento = document.getElementById(`tareas-${curso.id_curso}`);
            if (elemento) {
              if (tareasPorCalificar > 0) {
                elemento.textContent = tareasPorCalificar;
                elemento.parentElement.parentElement.classList.remove('bg-orange-50');
                elemento.parentElement.parentElement.classList.add('bg-orange-50');
              } else {
                elemento.textContent = 'âœ“';
                elemento.classList.remove('text-orange-600');
                elemento.classList.add('text-green-600');
                elemento.parentElement.parentElement.classList.remove('bg-orange-50');
                elemento.parentElement.parentElement.classList.add('bg-green-50');
              }
            }
          } catch (error) {
            console.error(`Error al cargar tareas por calificar para secciÃ³n ${seccion.id_seccion}:`, error);
          }
        }
      }

      // Actualizar contadores globales
      const totalEstudiantesGlobal = Array.from(cursosMap.values())
        .reduce((sum, curso) => sum + curso.secciones.reduce((s, sec) => s + (sec.total_estudiantes || 0), 0), 0);
      
      console.log('ðŸ“Š Total estudiantes global:', totalEstudiantesGlobal);
      
      document.getElementById('cursos-cargo').textContent = cursosMap.size;
      document.getElementById('estudiantes-totales').textContent = totalEstudiantesGlobal;
      
      // Calcular total de tareas por calificar de todas las secciones
      let totalTareasPorCalificar = 0;
      for (const curso of cursosMap.values()) {
        for (const seccion of curso.secciones) {
          try {
            const estadisticas = await getTareasPorCalificarSeccion(seccion.id_seccion);
            totalTareasPorCalificar += (estadisticas.tareas_por_calificar || 0);
          } catch (error) {
            console.error(`Error al calcular tareas por calificar:`, error);
          }
        }
      }
      
      document.getElementById('tareas-calificar').textContent = totalTareasPorCalificar;

    } catch (error) {
      console.error('Error al cargar cursos del docente:', error);
      const cursosContainer = document.getElementById('cursos-container');
      cursosContainer.innerHTML = `
        <div class="col-span-full bg-white rounded-lg shadow p-6">
          <p class="text-red-500 text-center">Error al cargar los cursos. Por favor, intenta de nuevo.</p>
        </div>
      `;
    }
  });
</script>

