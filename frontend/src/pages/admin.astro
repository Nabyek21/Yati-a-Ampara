---
import AdminLayout from '../layouts/AdminLayout.astro';
import AdminHeader from '../components/AdminHeader.astro';
---

<AdminLayout title="Dashboard - Yatiña Ampara">
  <AdminHeader>Dashboard</AdminHeader>
  <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
    <!-- Tarjetas de Métricas -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <p class="text-gray-600 text-sm font-medium">Total Usuarios</p>
            <p class="text-3xl font-bold text-gray-800 mt-2" id="total-usuarios">-</p>
            <p class="text-sm text-green-600 mt-1" id="usuarios-activos">- activos</p>
            <button id="export-usuarios-card" class="mt-3 text-purple-600 hover:text-purple-800 text-sm font-medium flex items-center">
              <i class="fas fa-download mr-1"></i> Exportar
            </button>
          </div>
          <div class="bg-purple-100 rounded-full p-4">
            <i class="fas fa-users text-purple-600 text-2xl"></i>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <p class="text-gray-600 text-sm font-medium">Total Docentes</p>
            <p class="text-3xl font-bold text-gray-800 mt-2" id="total-docentes">-</p>
            <button id="export-docentes-card" class="mt-3 text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center">
              <i class="fas fa-download mr-1"></i> Exportar
            </button>
          </div>
          <div class="bg-blue-100 rounded-full p-4">
            <i class="fas fa-chalkboard-teacher text-blue-600 text-2xl"></i>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <p class="text-gray-600 text-sm font-medium">Total Cursos</p>
            <p class="text-3xl font-bold text-gray-800 mt-2" id="total-cursos">-</p>
            <p class="text-sm text-green-600 mt-1" id="cursos-activos">- activos</p>
            <button id="export-cursos-card" class="mt-3 text-green-600 hover:text-green-800 text-sm font-medium flex items-center">
              <i class="fas fa-download mr-1"></i> Exportar
            </button>
          </div>
          <div class="bg-green-100 rounded-full p-4">
            <i class="fas fa-book text-green-600 text-2xl"></i>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <p class="text-gray-600 text-sm font-medium">Total Secciones</p>
            <p class="text-3xl font-bold text-gray-800 mt-2" id="total-secciones">-</p>
            <button id="export-secciones-card" class="mt-3 text-yellow-600 hover:text-yellow-800 text-sm font-medium flex items-center">
              <i class="fas fa-download mr-1"></i> Exportar
            </button>
          </div>
          <div class="bg-yellow-100 rounded-full p-4">
            <i class="fas fa-list-alt text-yellow-600 text-2xl"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Gráficos -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
      <!-- Gráfico de Usuarios por Estado -->
      <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Usuarios por Estado</h3>
        <canvas id="usuariosEstadoChart"></canvas>
      </div>

      <!-- Gráfico de Cursos por Estado -->
      <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Cursos por Estado</h3>
        <canvas id="cursosEstadoChart"></canvas>
      </div>

      <!-- Gráfico de Cursos por Especialidad -->
      <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Cursos por Especialidad</h3>
        <canvas id="cursosEspecialidadChart"></canvas>
      </div>

      <!-- Gráfico de Usuarios Registrados (Últimos 6 meses) -->
      <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Usuarios Registrados (Últimos 6 meses)</h3>
        <canvas id="usuariosMesChart"></canvas>
      </div>
    </div>

    <!-- Tablas de Datos -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Tabla de Usuarios por Estado -->
      <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Distribución de Usuarios</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200" id="table-usuarios-estado">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
              </tr>
            </thead>
            <tbody id="tbody-usuarios-estado" class="bg-white divide-y divide-gray-200">
              <!-- Se llenará dinámicamente -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Tabla de Cursos por Estado -->
      <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Distribución de Cursos</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200" id="table-cursos-estado">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
              </tr>
            </thead>
            <tbody id="tbody-cursos-estado" class="bg-white divide-y divide-gray-200">
              <!-- Se llenará dinámicamente -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
</AdminLayout>

<!-- Modal para seleccionar campos a exportar -->
<div id="export-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
    <div class="flex justify-between items-center pb-3 border-b">
      <h3 class="text-lg font-bold text-gray-900" id="export-modal-title">Seleccionar Campos para Exportar</h3>
      <button id="close-export-modal" class="text-gray-400 hover:text-gray-600">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="mt-4">
      <p class="text-sm text-gray-600 mb-4">Selecciona los campos que deseas incluir en la exportación:</p>
      <div id="export-fields-container" class="space-y-2 max-h-96 overflow-y-auto">
        <!-- Los checkboxes se generarán dinámicamente -->
      </div>
      <div class="flex justify-end space-x-2 mt-6">
        <button id="cancel-export" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">
          Cancelar
        </button>
        <button id="confirm-export" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">
          Exportar CSV
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script type="module">
  import {
    getGeneralStats,
    getUsuariosByEstado,
    getCursosByEstado,
    getCursosByEspecialidad,
    getUsuariosByMonth
  } from '../../public/services/statsService.js';
  import { getUsers } from '../../public/services/userService.js';
  import { getDocentes } from '../../public/services/docenteService.js';
  import { getCursos } from '../../public/services/cursoService.js';
  import { getSecciones } from '../../public/services/seccionService.js';

  // Definir campos disponibles para cada tipo de dato
  const fieldDefinitions = {
    usuarios: {
      id_usuario: 'ID Usuario',
      nombres: 'Nombres',
      apellidos: 'Apellidos',
      dni: 'DNI',
      correo: 'Correo',
      celular: 'Celular',
      fecha_registro: 'Fecha de Registro',
      nombre_estado: 'Estado',
      nombre_rol: 'Rol'
    },
    docentes: {
      id_docente_perfil: 'ID Docente',
      nombres: 'Nombres',
      apellidos: 'Apellidos',
      dni: 'DNI',
      correo: 'Correo',
      celular: 'Celular',
      nombre_especialidad: 'Especialidad',
      nombre_estado: 'Estado',
      fecha_registro: 'Fecha de Registro'
    },
    cursos: {
      id_curso: 'ID Curso',
      nombre: 'Nombre',
      descripcion: 'Descripción',
      nombre_especialidad: 'Especialidad',
      duracion_semanas: 'Duración (semanas)',
      nombre_estado: 'Estado'
    },
    secciones: {
      id_seccion: 'ID Sección',
      nombre_seccion: 'Nombre Sección',
      nombre_curso: 'Curso',
      nombres_docente: 'Nombres Docente',
      apellidos_docente: 'Apellidos Docente',
      nombre_modalidad: 'Modalidad',
      fecha_inicio: 'Fecha Inicio',
      fecha_fin: 'Fecha Fin',
      horario: 'Horario',
      nombre_estado: 'Estado'
    }
  };

  // Variables globales para el modal de exportación
  let currentExportType = null;
  let currentExportData = null;
  let exportModal = null;
  let exportFieldsContainer = null;

  // Función para exportar a CSV con campos seleccionados
  function exportToCSVWithFields(data, selectedFields, filename) {
    if (!data || data.length === 0) {
      alert('No hay datos para exportar');
      return;
    }

    if (!selectedFields || selectedFields.length === 0) {
      alert('Por favor selecciona al menos un campo para exportar');
      return;
    }

    // Obtener los nombres de los campos en español
    const fieldLabels = fieldDefinitions[currentExportType];
    const headers = selectedFields.map(field => fieldLabels[field] || field);
    
    // Crear el contenido CSV
    const csvRows = [
      headers.join(','),
      ...data.map(row => {
        return selectedFields.map(field => {
          const value = row[field] || '';
          // Escapar comillas y envolver en comillas si contiene comas o saltos de línea
          return `"${String(value).replace(/"/g, '""')}"`;
        }).join(',');
      })
    ];

    const csvContent = csvRows.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }

  // Función para abrir el modal de exportación
  function openExportModal(type, data) {
    currentExportType = type;
    currentExportData = data;
    
    const fields = fieldDefinitions[type];
    if (!fields) {
      alert('Tipo de exportación no válido');
      return;
    }

    // Actualizar el título del modal
    const titles = {
      usuarios: 'Exportar Usuarios',
      docentes: 'Exportar Docentes',
      cursos: 'Exportar Cursos',
      secciones: 'Exportar Secciones'
    };
    document.getElementById('export-modal-title').textContent = titles[type] || 'Exportar Datos';

    // Generar checkboxes para cada campo
    exportFieldsContainer.innerHTML = Object.entries(fields).map(([key, label]) => `
      <label class="flex items-center space-x-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
        <input type="checkbox" value="${key}" class="export-field-checkbox" checked>
        <span class="text-sm text-gray-700">${label}</span>
      </label>
    `).join('');

    // Mostrar el modal
    exportModal.classList.remove('hidden');
  }

  // Función para cerrar el modal
  function closeExportModal() {
    exportModal.classList.add('hidden');
    currentExportType = null;
    currentExportData = null;
  }

  let usuariosEstadoChart, cursosEstadoChart, cursosEspecialidadChart, usuariosMesChart;

  document.addEventListener('DOMContentLoaded', async () => {
    try {
      // Cargar estadísticas generales
      const generalStats = await getGeneralStats();
      document.getElementById('total-usuarios').textContent = generalStats.totalUsuarios;
      document.getElementById('usuarios-activos').textContent = `${generalStats.usuariosActivos} activos`;
      document.getElementById('total-docentes').textContent = generalStats.totalDocentes;
      document.getElementById('total-cursos').textContent = generalStats.totalCursos;
      document.getElementById('cursos-activos').textContent = `${generalStats.cursosActivos} activos`;
      document.getElementById('total-secciones').textContent = generalStats.totalSecciones;

      // Cargar datos para gráficos
      const usuariosEstado = await getUsuariosByEstado();
      const cursosEstado = await getCursosByEstado();
      const cursosEspecialidad = await getCursosByEspecialidad();
      const usuariosMes = await getUsuariosByMonth();

      // Renderizar tablas
      const tbodyUsuarios = document.getElementById('tbody-usuarios-estado');
      tbodyUsuarios.innerHTML = usuariosEstado.map(item => `
        <tr>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.estado}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.cantidad}</td>
        </tr>
      `).join('');

      const tbodyCursos = document.getElementById('tbody-cursos-estado');
      tbodyCursos.innerHTML = cursosEstado.map(item => `
        <tr>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.estado}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.cantidad}</td>
        </tr>
      `).join('');

      // Crear gráficos
      // Gráfico de Usuarios por Estado (Doughnut)
      const ctxUsuariosEstado = document.getElementById('usuariosEstadoChart').getContext('2d');
      usuariosEstadoChart = new Chart(ctxUsuariosEstado, {
        type: 'doughnut',
        data: {
          labels: usuariosEstado.map(item => item.estado),
          datasets: [{
            data: usuariosEstado.map(item => item.cantidad),
            backgroundColor: [
              '#10B981', // green
              '#EF4444', // red
              '#F59E0B', // yellow
              '#6B7280'  // gray
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true
        }
      });

      // Gráfico de Cursos por Estado (Doughnut)
      const ctxCursosEstado = document.getElementById('cursosEstadoChart').getContext('2d');
      cursosEstadoChart = new Chart(ctxCursosEstado, {
        type: 'doughnut',
        data: {
          labels: cursosEstado.map(item => item.estado),
          datasets: [{
            data: cursosEstado.map(item => item.cantidad),
            backgroundColor: [
              '#10B981',
              '#EF4444',
              '#F59E0B',
              '#6B7280'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true
        }
      });

      // Gráfico de Cursos por Especialidad (Bar)
      const ctxCursosEspecialidad = document.getElementById('cursosEspecialidadChart').getContext('2d');
      cursosEspecialidadChart = new Chart(ctxCursosEspecialidad, {
        type: 'bar',
        data: {
          labels: cursosEspecialidad.map(item => item.especialidad),
          datasets: [{
            label: 'Cantidad de Cursos',
            data: cursosEspecialidad.map(item => item.cantidad),
            backgroundColor: '#8B5CF6'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });

      // Gráfico de Usuarios por Mes (Line)
      const ctxUsuariosMes = document.getElementById('usuariosMesChart').getContext('2d');
      usuariosMesChart = new Chart(ctxUsuariosMes, {
        type: 'line',
        data: {
          labels: usuariosMes.map(item => item.mes),
          datasets: [{
            label: 'Usuarios Registrados',
            data: usuariosMes.map(item => item.cantidad),
            borderColor: '#8B5CF6',
            backgroundColor: 'rgba(139, 92, 246, 0.1)',
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });

      // Inicializar referencias al modal
      exportModal = document.getElementById('export-modal');
      exportFieldsContainer = document.getElementById('export-fields-container');

      // Event listeners para los botones de exportación en las tarjetas
      document.getElementById('export-usuarios-card').addEventListener('click', async () => {
        try {
          const usuarios = await getUsers({ rol: 3 }); // Solo estudiantes
          openExportModal('usuarios', usuarios);
        } catch (error) {
          console.error('Error al cargar usuarios:', error);
          alert('Error al cargar los datos de usuarios');
        }
      });

      document.getElementById('export-docentes-card').addEventListener('click', async () => {
        try {
          const docentes = await getDocentes();
          openExportModal('docentes', docentes);
        } catch (error) {
          console.error('Error al cargar docentes:', error);
          alert('Error al cargar los datos de docentes');
        }
      });

      document.getElementById('export-cursos-card').addEventListener('click', async () => {
        try {
          const cursos = await getCursos();
          openExportModal('cursos', cursos);
        } catch (error) {
          console.error('Error al cargar cursos:', error);
          alert('Error al cargar los datos de cursos');
        }
      });

      document.getElementById('export-secciones-card').addEventListener('click', async () => {
        try {
          const secciones = await getSecciones();
          openExportModal('secciones', secciones);
        } catch (error) {
          console.error('Error al cargar secciones:', error);
          alert('Error al cargar los datos de secciones');
        }
      });

      // Event listeners para el modal de exportación
      document.getElementById('close-export-modal').addEventListener('click', closeExportModal);
      document.getElementById('cancel-export').addEventListener('click', closeExportModal);
      document.getElementById('confirm-export').addEventListener('click', () => {
        const checkboxes = exportFieldsContainer.querySelectorAll('.export-field-checkbox:checked');
        const selectedFields = Array.from(checkboxes).map(cb => cb.value);
        
        if (selectedFields.length === 0) {
          alert('Por favor selecciona al menos un campo para exportar');
          return;
        }

        const filenames = {
          usuarios: 'usuarios.csv',
          docentes: 'docentes.csv',
          cursos: 'cursos.csv',
          secciones: 'secciones.csv'
        };

        exportToCSVWithFields(currentExportData, selectedFields, filenames[currentExportType]);
        closeExportModal();
      });

      // Cerrar modal al hacer clic fuera
      exportModal.addEventListener('click', (e) => {
        if (e.target === exportModal) {
          closeExportModal();
        }
      });

    } catch (error) {
      console.error('Error al cargar estadísticas:', error);
      alert('Error al cargar las estadísticas del dashboard');
    }
  });
</script>
