<div id="calificacionesContainer" class="hidden">
  <div class="max-w-6xl mx-auto p-6">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-4xl font-bold text-gray-800 mb-2">üìä Mis Calificaciones</h1>
      <p class="text-gray-600">Visualiza tu desempe√±o acad√©mico con el desglose detallado de notas</p>
    </div>

    <!-- Curso selector -->
    <div class="mb-8 p-4 bg-white rounded-lg border border-gray-200">
      <label for="cursoSelect" class="block text-sm font-medium text-gray-700 mb-2">Selecciona un Curso:</label>
      <select id="cursoSelect" class="w-full md:w-1/3 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="">Seleccionar curso...</option>
      </select>
    </div>

    <!-- Resumen General -->
    <div id="resumenGeneral" class="hidden mb-8 grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-lg shadow-lg">
        <p class="text-sm opacity-90 mb-1">Calificaci√≥n Final</p>
        <h2 id="notaFinal" class="text-3xl font-bold">-</h2>
        <p class="text-xs opacity-75 mt-1">De 100 puntos</p>
      </div>
      <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-lg shadow-lg">
        <p class="text-sm opacity-90 mb-1">Promedio Tareas</p>
        <h2 id="promTareas" class="text-3xl font-bold">-</h2>
        <p class="text-xs opacity-75 mt-1">Peso: 40%</p>
      </div>
      <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 text-white p-6 rounded-lg shadow-lg">
        <p class="text-sm opacity-90 mb-1">Promedio Ex√°menes</p>
        <h2 id="promExamenes" class="text-3xl font-bold">-</h2>
        <p class="text-xs opacity-75 mt-1">Peso: 50%</p>
      </div>
      <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-lg shadow-lg">
        <p class="text-sm opacity-90 mb-1">Promedio Quices</p>
        <h2 id="promQuices" class="text-3xl font-bold">-</h2>
        <p class="text-xs opacity-75 mt-1">Peso: 10%</p>
      </div>
    </div>

    <!-- Desglose por tipo -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
      <!-- Tareas -->
      <div class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
        <div class="bg-green-50 px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-800">üìù Tareas (40%)</h3>
        </div>
        <div id="tareasLista" class="divide-y divide-gray-200">
          <!-- Se llenar√° con JavaScript -->
        </div>
      </div>

      <!-- Ex√°menes -->
      <div class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
        <div class="bg-yellow-50 px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-800">üìÑ Ex√°menes (50%)</h3>
        </div>
        <div id="examenesLista" class="divide-y divide-gray-200">
          <!-- Se llenar√° con JavaScript -->
        </div>
      </div>

      <!-- Quices -->
      <div class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
        <div class="bg-purple-50 px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-800">‚úÖ Quices (10%)</h3>
        </div>
        <div id="quicesLista" class="divide-y divide-gray-200">
          <!-- Se llenar√° con JavaScript -->
        </div>
      </div>
    </div>

    <!-- Gr√°fico de evoluci√≥n -->
    <div class="bg-white rounded-lg border border-gray-200 shadow-sm p-6 mb-8">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">üìà Evoluci√≥n de Calificaciones</h3>
      <canvas id="graficoCalificaciones" width="400" height="100"></canvas>
    </div>

    <!-- Tabla detallada -->
    <div class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-800">üìã Detalle Completo</h3>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50 border-b border-gray-200">
            <tr>
              <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Actividad</th>
              <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Tipo</th>
              <th class="px-6 py-3 text-center text-sm font-medium text-gray-700">Puntaje</th>
              <th class="px-6 py-3 text-center text-sm font-medium text-gray-700">M√°ximo</th>
              <th class="px-6 py-3 text-center text-sm font-medium text-gray-700">Porcentaje</th>
              <th class="px-6 py-3 text-center text-sm font-medium text-gray-700">Estado</th>
            </tr>
          </thead>
          <tbody id="tablaDetalle" class="divide-y divide-gray-200">
            <!-- Se llenar√° con JavaScript -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Leyenda de estados -->
    <div class="mt-8 p-4 bg-blue-50 border border-blue-200 rounded-lg">
      <p class="text-sm font-medium text-gray-800 mb-2">Leyenda de Estados:</p>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
        <div class="flex items-center gap-2">
          <span class="inline-block w-3 h-3 bg-green-500 rounded-full"></span>
          <span>Completado</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="inline-block w-3 h-3 bg-yellow-500 rounded-full"></span>
          <span>Pendiente</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="inline-block w-3 h-3 bg-gray-400 rounded-full"></span>
          <span>No Presentado</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="inline-block w-3 h-3 bg-red-500 rounded-full"></span>
          <span>Vencido</span>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .calificacion-item {
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    hover: background-color: #f9fafb;
  }

  .calificacion-item:hover {
    background-color: #f9fafb;
  }

  .calificacion-titulo {
    font-size: 0.875rem;
    color: #6b7280;
    margin-bottom: 0.25rem;
  }

  .calificacion-valor {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1f2937;
  }

  .badge-estado {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .badge-completado {
    background: #dcfce7;
    color: #166534;
  }

  .badge-pendiente {
    background: #fef3c7;
    color: #92400e;
  }

  .badge-no-presentado {
    background: #f3f4f6;
    color: #374151;
  }

  .badge-vencido {
    background: #fee2e2;
    color: #7f1d1d;
  }
</style>

<script>
  import { 
    getPonderacionByCurso,
    getActividadesByCurso,
    getRespuestasAlumnoActividad
  } from '/services/moduloService.js';

  let id_curso = null;
  let id_matricula = null;
  let actividadesData = [];
  let ponderacionData = null;

  const container = document.getElementById('calificacionesContainer');
  const cursoSelect = document.getElementById('cursoSelect');
  const resumenGeneral = document.getElementById('resumenGeneral');

  // Cargar cursos (esto deber√≠a venir de donde se inicialice el componente)
  async function cargarCursos() {
    // Aqu√≠ se cargar√≠an los cursos del estudiante
    // Por ahora, se espera que se llame a iniciarCalificaciones()
  }

  // Cargar calificaciones de un curso
  async function cargarCalificacionesCurso(id) {
    try {
      id_curso = id;
      
      // Obtener ponderaciones
      const ponderRes = await getPonderacionByCurso(id_curso);
      ponderacionData = ponderRes.data;

      // Obtener actividades
      const actividadesRes = await getActividadesByCurso(id_curso);
      actividadesData = Array.isArray(actividadesRes) ? actividadesRes : [];

      // Procesar datos
      procesarCalificaciones();
      resumenGeneral.classList.remove('hidden');
    } catch (error) {
      console.error('Error cargando calificaciones:', error);
    }
  }

  function procesarCalificaciones() {
    const tareas = [];
    const examenes = [];
    const quices = [];

    // Separar por tipo
    actividadesData.forEach(act => {
      const item = {
        id_actividad: act.id_actividad,
        titulo: act.titulo,
        puntaje_max: act.puntaje_max,
        tipo: act.tipo,
        fecha_entrega: act.fecha_entrega
      };

      if (act.tipo === 'tarea') tareas.push(item);
      else if (act.tipo === 'examen') examenes.push(item);
      else if (act.tipo === 'quiz') quices.push(item);
    });

    // Renderizar por tipo
    renderizarActividades('tareasLista', tareas);
    renderizarActividades('examenesLista', examenes);
    renderizarActividades('quicesLista', quices);

    // Calcular promedios
    calcularPromedios(tareas, examenes, quices);

    // Renderizar tabla
    renderizarTablaDetalle([...tareas, ...examenes, ...quices]);
  }

  function renderizarActividades(containerId, actividades) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';

    if (actividades.length === 0) {
      container.innerHTML = '<div class="p-4 text-center text-gray-500">Sin actividades</div>';
      return;
    }

    actividades.forEach(act => {
      const div = document.createElement('div');
      div.className = 'calificacion-item';
      
      const hoy = new Date();
      const fechaEntrega = new Date(act.fecha_entrega);
      let estado = 'no-presentado';
      let estadoTexto = 'No Presentado';

      if (act.puntaje_obtenido !== undefined && act.puntaje_obtenido !== null) {
        estado = 'completado';
        estadoTexto = 'Completado';
      } else if (fechaEntrega < hoy) {
        estado = 'vencido';
        estadoTexto = 'Vencido';
      } else {
        estado = 'pendiente';
        estadoTexto = 'Pendiente';
      }

      div.innerHTML = `
        <div>
          <p class="calificacion-titulo">${act.titulo}</p>
          <p class="text-xs text-gray-500">${new Date(act.fecha_entrega).toLocaleDateString('es-ES')}</p>
        </div>
        <div class="text-right">
          <p class="calificacion-valor">${act.puntaje_obtenido || '-'}/${act.puntaje_max}</p>
          <span class="badge-estado badge-${estado}">${estadoTexto}</span>
        </div>
      `;
      container.appendChild(div);
    });
  }

  function calcularPromedios(tareas, examenes, quices) {
    const calcularPromedio = (arr) => {
      const completadas = arr.filter(a => a.puntaje_obtenido !== undefined);
      if (completadas.length === 0) return 0;
      const suma = completadas.reduce((s, a) => s + (a.puntaje_obtenido / a.puntaje_max * 100), 0);
      return (suma / completadas.length).toFixed(1);
    };

    const promTareas = calcularPromedio(tareas);
    const promExamenes = calcularPromedio(examenes);
    const promQuices = calcularPromedio(quices);

    const notaFinal = (
      promTareas * (ponderacionData?.peso_tareas || 40) / 100 +
      promExamenes * (ponderacionData?.peso_examenes || 50) / 100 +
      promQuices * (ponderacionData?.peso_quices || 10) / 100
    ).toFixed(1);

    document.getElementById('promTareas').textContent = promTareas;
    document.getElementById('promExamenes').textContent = promExamenes;
    document.getElementById('promQuices').textContent = promQuices;
    document.getElementById('notaFinal').textContent = notaFinal;
  }

  function renderizarTablaDetalle(actividades) {
    const tabla = document.getElementById('tablaDetalle');
    tabla.innerHTML = '';

    actividades.forEach(act => {
      const tr = document.createElement('tr');
      const porcentaje = act.puntaje_obtenido ? ((act.puntaje_obtenido / act.puntaje_max) * 100).toFixed(1) : '-';
      
      let estadoClass = 'badge-no-presentado';
      let estadoTexto = 'No Presentado';
      
      if (act.puntaje_obtenido !== undefined && act.puntaje_obtenido !== null) {
        estadoClass = 'badge-completado';
        estadoTexto = 'Completado';
      } else if (new Date(act.fecha_entrega) < new Date()) {
        estadoClass = 'badge-vencido';
        estadoTexto = 'Vencido';
      }

      tr.innerHTML = `
        <td class="px-6 py-4 text-sm text-gray-900">${act.titulo}</td>
        <td class="px-6 py-4 text-sm text-gray-500 capitalize">${act.tipo}</td>
        <td class="px-6 py-4 text-center text-sm font-medium">${act.puntaje_obtenido || '-'}</td>
        <td class="px-6 py-4 text-center text-sm text-gray-500">${act.puntaje_max}</td>
        <td class="px-6 py-4 text-center text-sm font-medium">${porcentaje}%</td>
        <td class="px-6 py-4 text-center">
          <span class="badge-estado ${estadoClass}">${estadoTexto}</span>
        </td>
      `;
      tabla.appendChild(tr);
    });
  }

  // Selector de curso
  cursoSelect?.addEventListener('change', (e) => {
    if (e.target.value) {
      cargarCalificacionesCurso(parseInt(e.target.value));
    }
  });

  // Exponer funci√≥n para inicializar
  window.iniciarCalificaciones = (matriculaId, cursosDisponibles) => {
    id_matricula = matriculaId;
    container.classList.remove('hidden');
    
    // Llenar selector de cursos
    cursoSelect.innerHTML = '<option value="">Seleccionar curso...</option>';
    cursosDisponibles?.forEach(curso => {
      const option = document.createElement('option');
      option.value = curso.id_curso;
      option.textContent = curso.nombre;
      cursoSelect.appendChild(option);
    });
  };
</script>
