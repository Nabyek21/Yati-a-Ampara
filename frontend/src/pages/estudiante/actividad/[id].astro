---
import UsuarioLayout from '../../../layouts/UsuarioLayout.astro';
import UsuarioHeader from '../../../components/UsuarioHeader.astro';
---

<UsuarioLayout title="Responder Actividad - Yatiña">
  <UsuarioHeader>Responder Actividad</UsuarioHeader>

  <main class="flex-1 overflow-auto p-6 bg-gray-100">
    <!-- Barra de navegación -->
    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
      <a href="javascript:history.back()" class="flex items-center text-purple-600 hover:text-purple-800 font-medium">
        <i class="fas fa-arrow-left mr-2"></i>
        Volver al Contenido
      </a>
    </div>

    <div class="max-w-4xl mx-auto">
      <!-- Información de la Actividad -->
      <div class="bg-white rounded-lg shadow-md p-8 mb-6">
        <div class="mb-6">
          <div class="flex items-center justify-between mb-4">
            <h1 class="text-3xl font-bold text-purple-800" id="actividad-titulo">Cargando...</h1>
            <span class="px-4 py-2 bg-blue-100 text-blue-800 rounded-full text-sm font-semibold" id="actividad-tipo">Tarea</span>
          </div>
          <p class="text-gray-600" id="actividad-descripcion"></p>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 pb-6 border-b border-gray-200">
          <div>
            <p class="text-gray-500 text-sm">Puntos Máximos</p>
            <p class="text-2xl font-bold text-purple-600" id="actividad-puntos">0</p>
          </div>
          <div>
            <p class="text-gray-500 text-sm">Fecha de Entrega</p>
            <p class="text-lg font-semibold text-gray-800" id="actividad-fecha">-</p>
          </div>
          <div>
            <p class="text-gray-500 text-sm">Estado</p>
            <p class="text-lg font-semibold" id="actividad-estado"><span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded">Pendiente</span></p>
          </div>
          <div>
            <p class="text-gray-500 text-sm">Mi Calificación</p>
            <p class="text-2xl font-bold text-gray-800" id="mi-calificacion">-</p>
          </div>
        </div>

        <div id="instrucciones-container" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
          <h3 class="font-bold text-blue-900 mb-2">Instrucciones</h3>
          <p class="text-blue-800" id="actividad-instrucciones">Cargando instrucciones...</p>
        </div>
      </div>

      <!-- Formulario de Respuesta -->
      <div class="bg-white rounded-lg shadow-md p-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Tu Respuesta</h2>
        
        <form id="respuesta-form" class="space-y-6">
          <!-- Contenedor de preguntas (para exámenes) -->
          <div id="preguntas-container" class="hidden space-y-8">
            <div id="preguntas-list">
              <!-- Se cargarán dinámicamente -->
            </div>
          </div>

          <!-- Contenedor para tareas (respuesta texto única) -->
          <div id="textarea-container" class="hidden">
            <label for="respuesta-texto" class="block text-gray-700 font-medium mb-2">Escribe tu respuesta:</label>
            <textarea 
              id="respuesta-texto" 
              rows="10" 
              placeholder="Ingresa tu respuesta aquí..." 
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
            ></textarea>
            <p class="text-gray-500 text-sm mt-2">Máximo 5000 caracteres</p>
          </div>

          <!-- Para Preguntas con archivo -->
          <div id="archivo-container" class="hidden">
            <label for="respuesta-archivo" class="block text-gray-700 font-medium mb-2">Subir archivo:</label>
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-purple-500 transition" id="drop-zone">
              <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
              <p class="text-gray-600">Arrastra tu archivo aquí o haz clic para seleccionar</p>
              <input type="file" id="respuesta-archivo" class="hidden">
              <p class="text-gray-500 text-sm mt-2" id="archivo-info">Archivos permitidos: PDF, Word, ZIP, Imágenes</p>
            </div>
          </div>

          <!-- Botones de acción -->
          <div class="flex gap-4 pt-6 border-t border-gray-200">
            <button 
              type="submit" 
              class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition"
            >
              <i class="fas fa-paper-plane mr-2"></i> Enviar Respuesta
            </button>
            <a 
              href="javascript:history.back()" 
              class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 px-6 rounded-lg transition text-center"
            >
              <i class="fas fa-times mr-2"></i> Cancelar
            </a>
          </div>
        </form>

        <!-- Mensaje de estado -->
        <div id="status-message" class="hidden mt-4 p-4 rounded-lg"></div>
      </div>

      <!-- Historial de entregas -->
      <div class="bg-white rounded-lg shadow-md p-8 mt-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Historial de Entregas</h2>
        <div id="historial-entregas" class="space-y-3">
          <p class="text-gray-500">Cargando historial...</p>
        </div>
      </div>
    </div>
  </main>
</UsuarioLayout>

<script>
  const API_URL = 'http://localhost:4000/api';
  let actividadActual = null;
  let preguntasActuales = [];
  let respuestasUsuario = {}; // Guardar respuestas del usuario

  document.addEventListener('DOMContentLoaded', async () => {
    const idActividad = window.location.pathname.split('/').pop();
    
    try {
      const token = localStorage.getItem('token');
      const user = JSON.parse(localStorage.getItem('user'));
      
      if (!token || !user) {
        window.location.href = '/login';
        return;
      }

      // Obtener datos de la actividad
      const actividadRes = await fetch(`${API_URL}/actividades/${idActividad}`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (!actividadRes.ok) {
        throw new Error('No se pudo cargar la actividad');
      }

      actividadActual = await actividadRes.json();
      
      // Llenar información de la actividad
      document.getElementById('actividad-titulo').textContent = actividadActual.titulo;
      document.getElementById('actividad-descripcion').textContent = actividadActual.descripcion || 'Sin descripción';
      document.getElementById('actividad-tipo').textContent = actividadActual.tipo.toUpperCase();
      document.getElementById('actividad-puntos').textContent = actividadActual.puntaje_max || 0;
      document.getElementById('actividad-instrucciones').textContent = actividadActual.instrucciones || 'Sin instrucciones adicionales';
      
      if (actividadActual.fecha_entrega) {
        const fecha = new Date(actividadActual.fecha_entrega);
        document.getElementById('actividad-fecha').textContent = fecha.toLocaleString('es-ES', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      // Mostrar interfaz según tipo de actividad
      if (actividadActual.tipo === 'examen') {
        // Cargar preguntas para examen
        await cargarPreguntas(idActividad, token);
        document.getElementById('preguntas-container').classList.remove('hidden');
      } else if (actividadActual.tipo === 'tarea') {
        // Mostrar textarea para tarea
        document.getElementById('textarea-container').classList.remove('hidden');
      }

      // Obtener respuesta anterior del estudiante si existe
      await cargarRespuestaAnterior(idActividad, token, user.id_usuario);
      
      // Cargar historial de entregas
      await cargarHistorialEntregas(idActividad, token, user.id_usuario);

    } catch (error) {
      console.error('Error:', error);
      mostrarError('Error al cargar la actividad');
    }
  });

  async function cargarPreguntas(idActividad, token) {
    try {
      const res = await fetch(`${API_URL}/preguntas?id_actividad=${idActividad}&include_opciones=true`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      if (!res.ok) {
        console.error('Error cargando preguntas:', res.status);
        return;
      }
      
      preguntasActuales = await res.json();
      renderizarPreguntas(preguntasActuales);
    } catch (error) {
      console.error('Error al cargar preguntas:', error);
      mostrarError('Error al cargar las preguntas');
    }
  }

  function renderizarPreguntas(preguntas) {
    const container = document.getElementById('preguntas-list');
    container.innerHTML = '';

    if (!preguntas || preguntas.length === 0) {
      container.innerHTML = '<p class="text-center text-gray-500">No hay preguntas en esta actividad</p>';
      return;
    }

    preguntas.forEach((pregunta, index) => {
      const div = document.createElement('div');
      div.className = 'bg-gray-50 rounded-lg p-6 border border-gray-200';
      
      let contenidoPregunta = '';
      
      // Encabezado de la pregunta
      contenidoPregunta += `
        <div class="mb-4">
          <div class="flex justify-between items-start mb-2">
            <h3 class="text-lg font-semibold text-gray-800">Pregunta ${index + 1}</h3>
            <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs font-semibold rounded">${pregunta.puntaje || 1} pts</span>
          </div>
          <p class="text-gray-700 text-base">${pregunta.enunciado}</p>
        </div>
      `;

      // Renderizar según tipo de pregunta
      if (pregunta.tipo === 'opcion') {
        // Preguntas de opción múltiple
        contenidoPregunta += `
          <div class="space-y-3">
            <label class="block text-sm font-medium text-gray-600 mb-3">Selecciona una opción:</label>
        `;
        
        if (pregunta.opciones && Array.isArray(pregunta.opciones)) {
          pregunta.opciones.forEach((opcion, opIdx) => {
            const opcionId = `pregunta_${pregunta.id_pregunta}_opcion_${opcion.id_respuesta_opcion || opcion.id_opcion}`;
            contenidoPregunta += `
              <div class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-blue-50 transition">
                <input 
                  type="radio" 
                  name="pregunta_${pregunta.id_pregunta}" 
                  value="${opcion.id_respuesta_opcion || opcion.id_opcion}" 
                  id="${opcionId}"
                  class="w-4 h-4 text-purple-600"
                  data-pregunta-id="${pregunta.id_pregunta}"
                >
                <label for="${opcionId}" class="ml-3 cursor-pointer flex-1">
                  <span class="font-medium text-gray-700">${String.fromCharCode(65 + opIdx)}.</span>
                  <span class="ml-2">${opcion.texto}</span>
                </label>
              </div>
            `;
          });
        }
        
        contenidoPregunta += `</div>`;
      } else if (pregunta.tipo === 'texto') {
        // Preguntas de texto libre
        contenidoPregunta += `
          <div>
            <textarea 
              name="pregunta_${pregunta.id_pregunta}"
              data-pregunta-id="${pregunta.id_pregunta}"
              rows="4" 
              placeholder="Escribe tu respuesta aquí..."
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm"
            ></textarea>
            <p class="text-gray-500 text-xs mt-1">Máximo 1000 caracteres</p>
          </div>
        `;
      }

      div.innerHTML = contenidoPregunta;
      container.appendChild(div);
    });
  }

  async function cargarRespuestaAnterior(idActividad, token, idUsuario) {
    try {
      const res = await fetch(`${API_URL}/respuestas-alumnos/actividad/${idActividad}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      if (!res.ok) return;
      
      const data = await res.json();
      const respuestas = data.data || data;
      
      if (respuestas && respuestas.length > 0) {
        const ultimaRespuesta = respuestas[0];
        
        // Para tareas, cargar el texto
        if (ultimaRespuesta.respuesta_texto) {
          const textarea = document.getElementById('respuesta-texto');
          if (textarea) {
            textarea.value = ultimaRespuesta.respuesta_texto;
          }
        }
        
        // Mostrar calificación
        if (ultimaRespuesta.calificacion) {
          document.getElementById('mi-calificacion').textContent = ultimaRespuesta.calificacion + ' pts';
        }

        // Para exámenes, cargar respuestas de preguntas (si existen)
        // Esta lógica dependerá de cómo se estructure la respuesta en la BD
      }
    } catch (error) {
      console.error('Error al cargar respuesta anterior:', error);
    }
  }

  async function cargarHistorialEntregas(idActividad, token, idUsuario) {
    try {
      const res = await fetch(`${API_URL}/respuestas-alumnos/actividad/${idActividad}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      if (!res.ok) return;
      
      const data = await res.json();
      const respuestas = data.data || data;
      const historialContainer = document.getElementById('historial-entregas');
      
      if (!respuestas || respuestas.length === 0) {
        historialContainer.innerHTML = '<p class="text-gray-500">Aún no has entregado esta actividad</p>';
        return;
      }
      
      historialContainer.innerHTML = respuestas.map((resp, index) => `
        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
          <div class="flex justify-between items-start">
            <div>
              <p class="font-semibold text-gray-800">Entrega ${index + 1}</p>
              <p class="text-sm text-gray-600">${new Date(resp.fecha_entrega).toLocaleString('es-ES')}</p>
            </div>
            <div class="text-right">
              <p class="text-sm text-gray-600">Calificación:</p>
              <p class="text-2xl font-bold ${resp.calificacion ? 'text-green-600' : 'text-gray-400'}">
                ${resp.calificacion ? `${resp.calificacion} pts` : 'Pendiente'}
              </p>
            </div>
          </div>
        </div>
      `).join('');
    } catch (error) {
      console.error('Error al cargar historial:', error);
    }
  }

  // Manejo del formulario
  document.getElementById('respuesta-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const idActividad = window.location.pathname.split('/').pop();
    const token = localStorage.getItem('token');
    const user = JSON.parse(localStorage.getItem('user'));
    
    try {
      // Determinar qué tipo de respuesta se envía
      if (actividadActual.tipo === 'examen') {
        // Procesar respuestas de preguntas
        await enviarRespuestasExamen(idActividad, token, user);
      } else if (actividadActual.tipo === 'tarea') {
        // Procesar respuesta de tarea
        await enviarRespuestaTarea(idActividad, token, user);
      }

      mostrarExito('¡Respuesta enviada correctamente!');
      setTimeout(() => {
        window.history.back();
      }, 2000);
    } catch (error) {
      console.error('Error:', error);
      mostrarError('Error al enviar la respuesta: ' + error.message);
    }
  });

  async function enviarRespuestasExamen(idActividad, token, user) {
    // Recolectar todas las respuestas de preguntas
    const respuestas = [];

    preguntasActuales.forEach(pregunta => {
      let respuesta = null;

      if (pregunta.tipo === 'opcion') {
        // Obtener opción seleccionada
        const selectedRadio = document.querySelector(`input[name="pregunta_${pregunta.id_pregunta}"]:checked`);
        if (selectedRadio) {
          respuesta = {
            id_pregunta: pregunta.id_pregunta,
            tipo: 'opcion',
            id_opcion: selectedRadio.value
          };
        }
      } else if (pregunta.tipo === 'texto') {
        // Obtener texto ingresado
        const textarea = document.querySelector(`textarea[name="pregunta_${pregunta.id_pregunta}"]`);
        if (textarea && textarea.value.trim()) {
          respuesta = {
            id_pregunta: pregunta.id_pregunta,
            tipo: 'texto',
            texto: textarea.value.trim()
          };
        }
      }

      if (respuesta) {
        respuestas.push(respuesta);
      }
    });

    if (respuestas.length === 0) {
      throw new Error('Debes responder al menos una pregunta');
    }

    // Enviar respuestas al backend
    const res = await fetch(`${API_URL}/respuestas-alumnos/enviar`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        id_actividad: idActividad,
        id_usuario: user.id_usuario,
        respuestas: respuestas
      })
    });

    if (!res.ok) {
      const error = await res.json();
      throw new Error(error.message || 'Error al enviar respuestas');
    }

    // Después de enviar, obtener la calificación total
    try {
      // Obtener matrícula del usuario
      const matriculaRes = await fetch(`${API_URL}/matriculas?id_usuario=${user.id_usuario}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      if (matriculaRes.ok) {
        const matriculas = await matriculaRes.json();
        if (matriculas && matriculas.length > 0) {
          const id_matricula = matriculas[0].id_matricula;
          
          // Obtener calificación
          const calRes = await fetch(`${API_URL}/respuestas-alumnos/calificacion/${idActividad}/${id_matricula}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          
          if (calRes.ok) {
            const calData = await calRes.json();
            if (calData.data) {
              // Mostrar calificación en el documento
              const puntajeObtenido = calData.data.puntaje_obtenido_total;
              const puntajeMax = calData.data.puntaje_maximo_actividad;
              document.getElementById('mi-calificacion').textContent = `${puntajeObtenido}/${puntajeMax} pts`;
            }
          }
        }
      }
    } catch (err) {
      console.warn('No se pudo obtener la calificación:', err);
    }
  }

  async function enviarRespuestaTarea(idActividad, token, user) {
    const respuestaTexto = document.getElementById('respuesta-texto').value.trim();

    if (!respuestaTexto) {
      throw new Error('Debes escribir una respuesta');
    }

    const res = await fetch(`${API_URL}/respuestas-alumnos/enviar`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        id_actividad: idActividad,
        id_usuario: user.id_usuario,
        respuesta_texto: respuestaTexto
      })
    });

    if (!res.ok) {
      const error = await res.json();
      throw new Error(error.message || 'Error al enviar respuesta');
    }
  }

  // Funciones auxiliares
  function mostrarError(mensaje) {
    const statusDiv = document.getElementById('status-message');
    statusDiv.className = 'p-4 rounded-lg bg-red-100 text-red-700 border border-red-400';
    statusDiv.textContent = mensaje;
    statusDiv.classList.remove('hidden');
  }

  function mostrarExito(mensaje) {
    const statusDiv = document.getElementById('status-message');
    statusDiv.className = 'p-4 rounded-lg bg-green-100 text-green-700 border border-green-400';
    statusDiv.textContent = mensaje;
    statusDiv.classList.remove('hidden');
  }
</script>
