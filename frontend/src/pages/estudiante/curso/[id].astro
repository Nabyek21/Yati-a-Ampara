---
import EstudianteLayout from '../../../layouts/EstudianteLayout.astro';
import EstudianteHeader from '../../../components/EstudianteHeader.astro';

export async function getStaticPaths() {
  const paths = [];
  for (let i = 1; i <= 100; i++) {
    paths.push({ params: { id: i.toString() } });
  }
  return paths;
}
---

<EstudianteLayout title="M√≥dulos del Curso - Yati√±a">
  <EstudianteHeader>M√≥dulos del Curso</EstudianteHeader>
  <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
    <!-- Informaci√≥n del Curso -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <div class="flex items-center justify-between mb-4">
        <div class="flex-1">
          <h2 class="text-2xl font-bold text-purple-800 mb-2" id="curso-nombre">Cargando...</h2>
          <p class="text-gray-600" id="curso-descripcion"></p>
          <p class="text-sm text-gray-500 mt-2" id="total-semanas"></p>
        </div>
        <div id="modalidad-badge" class="ml-4">
          <!-- Badge de modalidad se cargar√° din√°micamente -->
        </div>
      </div>
    </div>

    <!-- Barra de Pesta√±as -->
    <div class="bg-white rounded-lg shadow-lg mb-6">
      <div class="border-b border-gray-200">
        <nav class="flex space-x-8 px-6" aria-label="Tabs">
          <button 
            id="tab-contenido" 
            class="tab-button active border-b-2 border-purple-600 py-4 px-1 text-sm font-medium text-purple-600"
            onclick="switchTab('contenido')"
          >
            Contenido
          </button>
          <button 
            id="tab-calificaciones" 
            class="tab-button border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300"
            onclick="switchTab('calificaciones')"
          >
            Mis Calificaciones
          </button>
        </nav>
      </div>
    </div>

    <!-- Pesta√±a: Contenido (M√≥dulos) -->
    <div id="content-contenido" class="tab-content">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <div id="modulos-container">
          <div class="text-center text-gray-500 py-8">
            <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
            <p>Cargando m√≥dulos...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Pesta√±a: Calificaciones -->
    <div id="content-calificaciones" class="tab-content hidden">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <div id="calificaciones-container">
          <div class="text-center text-gray-500 py-8">
            <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
            <p>Cargando calificaciones...</p>
          </div>
        </div>
      </div>
    </div>
  </main>
</EstudianteLayout>

<script>
console.log("‚úÖ Script inline ejecut√°ndose en estudiante/curso");

// Usar 'load' en lugar de 'DOMContentLoaded' para ejecutar DESPU√âS del layout
window.addEventListener('load', async () => {
  try {
    console.log("üöÄ Load event disparado");
    
    const API_URL = 'http://localhost:4000/api';
    
    // Obtener ID del curso desde URL
    const pathParts = window.location.pathname.split('/');
    const cursoId = parseInt(pathParts[pathParts.length - 1]);
    console.log("üìå Curso ID:", cursoId);

    // Obtener datos del usuario
    const user = localStorage.getItem('user');
    const userData = user ? JSON.parse(user) : null;
    const idUsuario = userData?.id_usuario;
    console.log("üë§ Usuario ID:", idUsuario);

    if (!idUsuario) {
      window.location.href = '/login';
      return;
    }

    // Obtener matr√≠culas
    const matriculasRes = await fetch(`${API_URL}/matriculas?usuario=${idUsuario}`);
    const matriculas = await matriculasRes.json();
    
    if (!matriculas || matriculas.length === 0) {
      document.getElementById('modulos-container').innerHTML = `
        <div class="text-center text-gray-500 py-8">
          <p>No est√°s inscrito en ning√∫n curso</p>
        </div>
      `;
      return;
    }

    const matricula = matriculas.find(m => m.id_curso === cursoId);
    if (!matricula) {
      document.getElementById('modulos-container').innerHTML = `
        <div class="text-center text-gray-500 py-8">
          <p>No est√°s inscrito en este curso</p>
        </div>
      `;
      return;
    }

    const idSeccion = matricula.id_seccion;
    console.log("üìç Secci√≥n ID:", idSeccion);

    // Obtener informaci√≥n del curso
    const cursosRes = await fetch(`${API_URL}/cursos`);
    const cursos = await cursosRes.json();
    const curso = cursos.find(c => c.id_curso === cursoId);

    if (curso) {
      document.getElementById('curso-nombre').textContent = curso.nombre;
      document.getElementById('curso-descripcion').textContent = curso.descripcion || 'Sin descripci√≥n';
    }

    // Obtener secciones
    const seccionesRes = await fetch(`${API_URL}/secciones?id_seccion=${idSeccion}`);
    const secciones = await seccionesRes.json();
    if (secciones.length > 0) {
      const seccion = secciones[0];
      document.getElementById('total-semanas').textContent = `Secci√≥n: ${seccion.nombre_seccion}`;
      if (seccion.nombre_modalidad) {
        document.getElementById('modalidad-badge').innerHTML = `
          <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-orange-100 text-orange-800">
            ${seccion.nombre_modalidad}
          </span>
        `;
      }
    }

    // Obtener m√≥dulos
    const modulosRes = await fetch(`${API_URL}/modulos?id_seccion=${idSeccion}`);
    const modulos = await modulosRes.json();
    console.log("üìö M√≥dulos cargados:", modulos.length);
    
    if (modulos.length === 0) {
      document.getElementById('modulos-container').innerHTML = `
        <div class="text-center text-gray-500 py-8">
          <p>Este curso no tiene m√≥dulos disponibles a√∫n</p>
        </div>
      `;
      return;
    }

    document.getElementById('total-semanas').textContent = `Total de semanas (${modulos.length})`;

    // Cargar contenido y actividades para cada m√≥dulo
    console.log("üîÑ Cargando contenido y actividades...");
    const modulosConContenido = await Promise.all(
      modulos.map(async (modulo) => {
        try {
          console.log(`üîÑ M√≥dulo ${modulo.id_modulo}: cargando contenido y actividades`);
          
          const contenidoRes = await fetch(`${API_URL}/modulo-contenido?id_modulo=${modulo.id_modulo}&id_seccion=${idSeccion}`);
          const contenido = await contenidoRes.json();
          
          const actividadesRes = await fetch(`${API_URL}/actividades?id_modulo=${modulo.id_modulo}&id_seccion=${idSeccion}`);
          const actividades = await actividadesRes.json();
          
          console.log(`‚úÖ M√≥dulo ${modulo.id_modulo}: ${actividades?.length || 0} actividades, ${contenido?.length || 0} contenidos`);
          
          return { ...modulo, contenido: contenido || [], actividades: actividades || [] };
        } catch (error) {
          console.error(`‚ùå Error m√≥dulo ${modulo.id_modulo}:`, error);
          return { ...modulo, contenido: [], actividades: [] };
        }
      })
    );

    console.log('‚úÖ Todos los m√≥dulos cargados:', modulosConContenido.length);
    renderModulos(modulosConContenido, idSeccion);

  } catch (error) {
    console.error('‚ùå Error:', error);
    document.getElementById('modulos-container').innerHTML = `
      <div class="text-center text-red-500 py-8">
        <p>Error al cargar los m√≥dulos. Por favor, intenta de nuevo.</p>
      </div>
    `;
  }
});

function renderModulos(modulos, seccionId) {
  const container = document.getElementById('modulos-container');

  const html = modulos.map((modulo, index) => {
    const contenidoList = (modulo.contenido || []).map(cont => {
      const iconoTipo = {
        'video': 'fa-video text-red-600',
        'pdf': 'fa-file-pdf text-red-500',
        'archivo': 'fa-file text-blue-600',
        'link': 'fa-link text-purple-600',
        'texto': 'fa-align-left text-gray-600'
      }[cont.tipo] || 'fa-file text-gray-600';

      return `
        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition">
          <i class="fas ${iconoTipo} text-lg flex-shrink-0 mt-1"></i>
          <div class="flex-1">
            <p class="font-medium text-gray-800">${cont.titulo}</p>
            ${cont.descripcion ? `<p class="text-sm text-gray-600 mt-1">${cont.descripcion}</p>` : ''}
          </div>
        </div>
      `;
    }).join('');

    const actividadesList = (modulo.actividades || []).map(act => {
      const tipoIcon = {
        'tarea': 'fa-tasks',
        'examen': 'fa-file-alt',
        'quiz': 'fa-question-circle'
      }[act.tipo] || 'fa-file-alt';

      const tipoColor = {
        'tarea': 'text-blue-600',
        'examen': 'text-red-600',
        'quiz': 'text-green-600'
      }[act.tipo] || 'text-gray-600';

      const fechaEntrega = act.fecha_entrega 
        ? new Date(act.fecha_entrega).toLocaleString('es-ES', { 
            day: '2-digit', 
            month: '2-digit', 
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          })
        : 'Sin fecha';

      return `
        <div class="bg-orange-50 rounded-lg p-4 border border-orange-200 hover:shadow-md transition">
          <div class="flex items-start justify-between gap-4">
            <div class="flex items-start space-x-3 flex-1">
              <i class="fas ${tipoIcon} ${tipoColor} text-lg mt-1 flex-shrink-0"></i>
              <div class="flex-1">
                <p class="font-bold text-gray-800">${act.titulo}</p>
                <div class="flex items-center gap-3 text-xs text-gray-600 mt-2">
                  <span class="px-2 py-1 bg-orange-100 text-orange-700 rounded font-semibold">${act.tipo.toUpperCase()}</span>
                  <span><i class="fas fa-calendar mr-1"></i>${fechaEntrega}</span>
                  <span><i class="fas fa-star mr-1"></i>${act.puntaje_max} pts</span>
                </div>
                ${act.descripcion ? `<p class="text-sm text-gray-700 mt-2">${act.descripcion}</p>` : ''}
              </div>
            </div>
            <button onclick="abrirResponderActividad(${act.id_actividad})" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-semibold whitespace-nowrap transition shadow-md hover:shadow-lg">
              <i class="fas fa-pen-square mr-1"></i> Responder
            </button>
          </div>
        </div>
      `;
    }).join('');

    return `
      <div class="mb-6 border rounded-lg overflow-hidden shadow">
        <div 
          class="bg-gradient-to-r from-purple-600 to-purple-700 p-4 cursor-pointer hover:from-purple-700 hover:to-purple-800 transition"
          onclick="toggleModulo('modulo-${modulo.id_modulo}')"
        >
          <div class="flex items-center justify-between text-white">
            <div class="flex items-center space-x-3">
              <i class="fas fa-chevron-down text-lg" id="icon-modulo-${modulo.id_modulo}"></i>
              <h3 class="text-lg font-bold">Semana ${index + 1}: ${modulo.nombre_modulo}</h3>
            </div>
            <div class="text-sm">
              <span class="mx-2">${modulo.contenido?.length || 0} contenidos</span>
              <span class="mx-2">${modulo.actividades?.length || 0} actividades</span>
            </div>
          </div>
        </div>
        
        <div id="modulo-${modulo.id_modulo}" class="bg-white p-6 space-y-6">
          ${contenidoList.length > 0 ? `
            <div>
              <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                <i class="fas fa-book text-purple-600 mr-2"></i>
                Contenido
              </h4>
              <div class="space-y-2">
                ${contenidoList}
              </div>
            </div>
          ` : ''}

          ${actividadesList.length > 0 ? `
            <div>
              <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                <i class="fas fa-tasks text-blue-600 mr-2"></i>
                Actividades
              </h4>
              <div class="space-y-3">
                ${actividadesList}
              </div>
            </div>
          ` : ''}

          ${contenidoList.length === 0 && actividadesList.length === 0 ? `
            <div class="text-center text-gray-500 py-8">
              <i class="fas fa-folder-open text-4xl mb-2 text-gray-300"></i>
              <p>Este m√≥dulo no tiene contenido ni actividades a√∫n</p>
            </div>
          ` : ''}
        </div>
      </div>
    `;
  }).join('');

  container.innerHTML = html;
}

window.toggleModulo = function(moduloId) {
  const modulo = document.getElementById(moduloId);
  const icon = document.getElementById(`icon-${moduloId}`);
  
  if (modulo.classList.contains('hidden')) {
    modulo.classList.remove('hidden');
    icon.classList.remove('rotate-180');
  } else {
    modulo.classList.add('hidden');
    icon.classList.add('rotate-180');
  }
};

window.switchTab = function(tabName) {
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.add('hidden');
  });
  
  document.querySelectorAll('.tab-button').forEach(button => {
    button.classList.remove('active', 'border-purple-600', 'text-purple-600');
    button.classList.add('border-transparent', 'text-gray-500');
  });
  
  document.getElementById(`content-${tabName}`).classList.remove('hidden');
  const activeTab = document.getElementById(`tab-${tabName}`);
  activeTab.classList.add('active', 'border-purple-600', 'text-purple-600');
  activeTab.classList.remove('border-transparent', 'text-gray-500');

  if (tabName === 'calificaciones') {
    loadCalificaciones();
  }
};

async function loadCalificaciones() {
  const container = document.getElementById('calificaciones-container');
  try {
    container.innerHTML = `
      <div class="text-center text-gray-500 py-8">
        <i class="fas fa-chart-bar text-4xl mb-4 text-blue-400"></i>
        <p>Panel de calificaciones en desarrollo...</p>
      </div>
    `;
  } catch (error) {
    console.error('Error al cargar calificaciones:', error);
  }
}

window.abrirResponderActividad = function(idActividad) {
  window.location.href = `/estudiante/actividad/${idActividad}`;
};

// Expandir primer m√≥dulo autom√°ticamente
window.addEventListener('load', () => {
  const primerModuloHeader = document.querySelector('[onclick*="toggleModulo"]');
  if (primerModuloHeader) {
    primerModuloHeader.click();
  }
});
</script>

<style>
  .rotate-180 {
    transform: rotate(180deg);
  }

  .tab-button.active {
    @apply border-purple-600 text-purple-600;
  }

  .tab-button {
    @apply transition-all duration-200;
  }
</style>
