---
import UsuarioLayout from '../../../layouts/UsuarioLayout.astro';
import UsuarioHeader from '../../../components/UsuarioHeader.astro';

export const prerender = false;
---

<UsuarioLayout title="Ver Contenido - Yatiña">
  <UsuarioHeader>Ver Contenido</UsuarioHeader>

  <main class="flex-1 overflow-auto p-6 bg-gray-100">
    <!-- Barra de navegación -->
    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
      <a href="javascript:history.back()" class="flex items-center text-purple-600 hover:text-purple-800 font-medium">
        <i class="fas fa-arrow-left mr-2"></i>
        Volver al Contenido
      </a>
    </div>

    <div class="max-w-4xl mx-auto">
      <!-- Información del Contenido -->
      <div class="bg-white rounded-lg shadow-md p-8 mb-6">
        <h1 class="text-3xl font-bold text-purple-800 mb-4" id="contenido-titulo">Cargando...</h1>
        <p class="text-gray-600 mb-6" id="contenido-descripcion"></p>
        
        <div class="mb-6 pb-6 border-b border-gray-200">
          <span class="px-4 py-2 bg-blue-100 text-blue-800 rounded-full text-sm font-semibold" id="contenido-tipo">Archivo</span>
        </div>

        <!-- Vista previa o descarga -->
        <div id="contenido-preview" class="bg-gray-50 rounded-lg p-8 border border-gray-200">
          <div class="text-center">
            <i class="fas fa-file text-6xl text-gray-400 mb-4"></i>
            <p class="text-gray-600 mb-4">Contenido cargando...</p>
          </div>
        </div>

        <!-- Botón de descarga -->
        <div class="mt-8 flex gap-4">
          <button id="descargar-btn" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition hidden">
            <i class="fas fa-download mr-2"></i> Descargar Archivo
          </button>
          <button id="abrir-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition hidden">
            <i class="fas fa-external-link-alt mr-2"></i> Abrir en Nueva Pestaña
          </button>
        </div>
      </div>
    </div>
  </main>
</UsuarioLayout>

<script>
  const API_URL = 'http://localhost:4000/api';

  document.addEventListener('DOMContentLoaded', async () => {
    // Extraer ID del pathname: /estudiante/contenido/123
    const pathParts = window.location.pathname.split('/').filter(p => p);
    const idContenido = pathParts[pathParts.length - 1];
    
    console.log('Path completo:', window.location.pathname);
    console.log('Path parts:', pathParts);
    console.log('ID Contenido extraído:', idContenido);
    console.log('ID es número?:', !isNaN(idContenido) && idContenido !== '');
    
    try {
      const token = localStorage.getItem('token');
      const user = JSON.parse(localStorage.getItem('user'));
      
      if (!token || !user) {
        window.location.href = '/login';
        return;
      }

      // Validar que ID es válido
      if (isNaN(idContenido) || idContenido === '') {
        throw new Error(`ID inválido: "${idContenido}"`);
      }

      // Obtener datos del contenido
      const url = `${API_URL}/modulo-contenido/${idContenido}`;
      console.log('URL de fetch:', url);
      
      const contenidoRes = await fetch(url, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (!contenidoRes.ok) {
        throw new Error('No se pudo cargar el contenido');
      }

      const contenido = await contenidoRes.json();
      
      // Llenar información del contenido
      document.getElementById('contenido-titulo').textContent = contenido.titulo || 'Contenido';
      document.getElementById('contenido-descripcion').textContent = contenido.descripcion || 'Sin descripción';
      document.getElementById('contenido-tipo').textContent = (contenido.tipo || 'archivo').toUpperCase();
      
      // Determinar cómo mostrar el contenido
      if (contenido.tipo === 'archivo' || contenido.archivo || contenido.url_contenido) {
        mostrarArchivo(contenido);
      } else if (contenido.tipo === 'texto') {
        mostrarTexto(contenido);
      } else if (contenido.tipo === 'video') {
        mostrarVideo(contenido);
      } else if (contenido.tipo === 'enlace') {
        mostrarEnlace(contenido);
      }

    } catch (error) {
      console.error('Error:', error);
      document.getElementById('contenido-preview').innerHTML = `
        <div class="text-center text-red-600">
          <i class="fas fa-exclamation-circle text-4xl mb-2"></i>
          <p>Error al cargar el contenido</p>
        </div>
      `;
    }
  });

  function mostrarArchivo(contenido) {
    const fileUrl = contenido.url_contenido || (contenido.archivo ? `http://localhost:4000/uploads/${contenido.archivo}` : null);
    
    if (!fileUrl) {
      document.getElementById('contenido-preview').innerHTML = '<p class="text-gray-600">No hay archivo disponible</p>';
      return;
    }

    const extension = fileUrl.split('.').pop().toLowerCase();
    const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(extension);
    const isPdf = extension === 'pdf';

    if (isImage) {
      document.getElementById('contenido-preview').innerHTML = `
        <img src="${fileUrl}" alt="${contenido.titulo}" class="max-w-full h-auto rounded-lg">
      `;
    } else if (isPdf) {
      document.getElementById('contenido-preview').innerHTML = `
        <iframe src="${fileUrl}" class="w-full h-96 rounded-lg border border-gray-300"></iframe>
      `;
    } else {
      document.getElementById('contenido-preview').innerHTML = `
        <div class="text-center py-8">
          <i class="fas fa-file text-6xl text-gray-400 mb-4"></i>
          <p class="text-gray-600 mb-4">Archivo: ${extension.toUpperCase()}</p>
          <p class="text-gray-500">Haz clic en descargar para obtener el archivo</p>
        </div>
      `;
    }

    // Mostrar botones
    document.getElementById('descargar-btn').classList.remove('hidden');
    document.getElementById('descargar-btn').onclick = () => {
      const a = document.createElement('a');
      a.href = fileUrl;
      a.download = contenido.titulo || 'descarga';
      a.click();
    };

    document.getElementById('abrir-btn').classList.remove('hidden');
    document.getElementById('abrir-btn').onclick = () => {
      window.open(fileUrl, '_blank');
    };
  }

  function mostrarTexto(contenido) {
    document.getElementById('contenido-preview').innerHTML = `
      <div class="prose max-w-none">
        <div class="bg-white p-6 rounded-lg border border-gray-200">
          ${contenido.texto || contenido.descripcion}
        </div>
      </div>
    `;
  }

  function mostrarVideo(contenido) {
    if (contenido.url_contenido) {
      document.getElementById('contenido-preview').innerHTML = `
        <video controls class="w-full rounded-lg">
          <source src="${contenido.url_contenido}" type="video/mp4">
          Tu navegador no soporta videos.
        </video>
      `;
    }
  }

  function mostrarEnlace(contenido) {
    document.getElementById('contenido-preview').innerHTML = `
      <div class="text-center py-8">
        <i class="fas fa-link text-6xl text-blue-400 mb-4"></i>
        <p class="text-gray-600 mb-4">Enlace externo</p>
        <a href="${contenido.url_contenido}" target="_blank" class="inline-block px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold">
          Abrir Enlace
        </a>
      </div>
    `;
  }
</script>
